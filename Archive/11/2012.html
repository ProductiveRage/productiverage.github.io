<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title>Productive Rage - November 2012</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#393939" />
	<link rel="stylesheet" type="text/css" media="all" href="/Content/Styles.css" />
	<link rel="stylesheet" type="text/css" media="print" href="/Content/PrintOverrides.css" />
	<meta name="robots" content="noindex, follow" />
	<link rel="shortcut icon" href="/favicon.ico" />
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.productiverage.com/feed" />
	<script type="text/javascript">
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', "UA-32312857-1", { 'storage': 'none' });
		ga('send', 'pageview');
	</script>
	<script type="text/javascript">
		var darkModeEnabledLocalStorageKey = "DarkMode";
		var darkModeHtmlWrapperClassName = "DarkMode";
		function IsDarkModeEnabled() {
			return localStorage.getItem(darkModeEnabledLocalStorageKey) !== null;
		}
		if (IsDarkModeEnabled()) {
			document.querySelector("html").classList.add(darkModeHtmlWrapperClassName);
		}
	</script>

    <meta name="description" content="Archive for November 2012" />
</head>

<body>

	<div class="Header">
		<div class="HeaderContent">
			<h1>
				<a href="/">Productive Rage</a>
			</h1>
			<span class="Tagline">Dan's techie ramblings</span>
		</div>
	</div>

	<div class="WrapperOuter">
		<div class="Wrapper">
			<div class="Main HasSideBar">
				

        <script type="text/javascript">
            var disqus_shortname = "productiverage";
            document.addEventListener(
                "DOMContentLoaded",
                function () {
                    var commentsLinks = document.querySelectorAll("div.Content p.Comments");
                    for (var i = 0; i < commentsLinks.length; i++) {
                        commentsLinks[i].style.display = "block";
                    }
                }
            );
        </script>

    <div class="Content ArchiveByMonth">
        <p class="PostDate">26 November 2012</p><h2 id="persistent-immutable-lists"><a href="/persistent-immutable-lists">Persistent Immutable Lists</a></h2>
<p>I've written before about immutable data structures (I'm all for them; see <a href="/i-love-immutable-data">I love Immutable Data</a> and <a href="/problems-in-immutabilityland">Problems in Immutability-land</a>) but watching a talk recently by Clojure-creator Rich Hickey made me think about one particular area again recently. In that first post I put up some example cost for an Immutable List that wrapped the .Net List&lt;T&gt; class - this was very simple to implement and understand, and in many cases I was using the immutable class as a return type or a method argument which meant that the instance would be built once and futher manipulations would be limited. This meant that I wasn't too concerned with internally creating a new list instance each time a new immutable instance was required and copying the references over.</p>
<p>However, in this talk it was reiterated that all of the core data structures in Clojure were intended to be immutable and that considerable work was done to ensure that the performance of these structures was sufficient that it could compete with Java and C#. A persistent linked list structure was used so that operations could be performed without having to recreate the entire dataset.</p>
<p>This is something that I didn't know a huge amount about but sounded like it could be an interesting avenue to explore!</p>
<h3 id="a-basic-introduction-into-the-singly-linked-list"><a href="/persistent-immutable-lists#a-basic-introduction-into-the-singly-linked-list">A basic introduction into the singly-linked list</a></h3>
<p>The singly-linked list is a fairly basic structure built around nodes; each node has a value and a link to the next node, if there is one. We know we're at the end of the list when the current node has a null &quot;next&quot; node reference.</p>
<p>An empty list would have a null &quot;head&quot; node.</p>
<p>An int list with a single item would have a head node of the form</p>
<pre><code>{ 1, null }
</code></pre>
<p>where the value of the item is 1 and there is no next node.</p>
<p>An int list with two items could be illustrated as</p>
<pre><code>{ 1, { 2, null } }
</code></pre>
<p>And one with four values as</p>
<pre><code>{ 1, { 2, { 3, { 4, null } } } }
</code></pre>
<p>Well, you get the idea!</p>
<p>The interesting thing comes when we look at how the structure changes as items are added. Starting off with an empty list and adding items one at a time to the front of the list, the structure grows in this manner:</p>
<pre><code>{ 1, null }

{ 2, { 1, null } }

{ 3, { 2, { 1, null } } }

{ 4, { 3, { 2, { 1, null } } } }
</code></pre>
<p>Each time we take a list L0 and create a new instance L1 by adding a single item, the head node of L1 can be taken to be a new node that contains the new value and whose &quot;next&quot; reference points to the head node of L0. This is where the &quot;persistent&quot; part comes into play. (This is only possible if the nodes themselves are immutable as otherwise one instance of the list could affect the data in another instance if they shared node chain references where the nodes were <em>not</em> immutable).</p>
<p>This means that creating a new list with a new item is a very simple and fast action! This operation is considerably faster than the doing the same on the original immutable list approach I was using, especially as the size of the list grows.</p>
<p>Enumerating the list is also straight-forward; we start at the head node (if non-null) and then walk down the &quot;next&quot; references until we hit a null, indicating the end of the list.</p>
<p>A basic implementation of this could be:</p>
<pre><code>public class SimplePersistentImmutableList&lt;T&gt; : IEnumerable&lt;T&gt;
{
    private readonly Node _head;
    public SimplePersistentImmutableList() : this(null) { }
    private SimplePersistentImmutableList(Node head)
    {
        _head = head;
    }

    public SimplePersistentImmutableList&lt;T&gt; InsertAtStart(T value)
    {
        return new SimplePersistentImmutableList&lt;T&gt;(
            new Node(value, _head)
        );
    }

    public IEnumerator&lt;T&gt; GetEnumerator()
    {
        return new SetEnumerator(_head);
    }

    IEnumerator IEnumerable.GetEnumerator()
    {
        return GetEnumerator();
    }

    private class Node
    {
        public Node(T value, Node next)
        {
            Value = value;
            Next = next;
        }

        public T Value { get; private set; }

        /// &lt;summary&gt;
        /// This will be null if there is no next node
        /// &lt;/summary&gt;
        public Node Next { get; private set; }
    }

    private class SetEnumerator : IEnumerator&lt;T&gt;
    {
        private readonly Node _topNode;
        private Node _currentNode;
        public SetEnumerator(Node topNode)
        {
            // The way that the enumeration operates is that it will call MoveNext before
            // trying to retrieve the first value when processing a foreach loop to ensure
            // that data is present. In order to deal with this, we need to wrap the Top
            // Node in another node so that the first MoveNext call moves us to the start
            // of the data.
            _topNode = new Node(default(T), topNode);
            _currentNode = _topNode;
        }

        public void Dispose() { }

        public T Current
        {
            get
            {
                if (_currentNode == null)
                    throw new InvalidOperationException(&quot;No Current value&quot;);
                return _currentNode.Value;
            }
        }

        object IEnumerator.Current
        {
            get { return Current; }
        }

        public bool MoveNext()
        {
            if ((_currentNode == null) || (_currentNode.Next == null))
                return false;
            _currentNode = _currentNode.Next;
            return true;
        }

        public void Reset()
        {
            _currentNode = _topNode;
        }
    }
}
</code></pre>
<p>And most of that code is the implementation of IEnumerable!</p>
<h3 id="limitations"><a href="/persistent-immutable-lists#limitations">Limitations</a></h3>
<p>This example <em>only</em> exposes an InsertAtStart method as a manner in which to alter the list. An obvious counterpart would be to add a RemoveFromStart method, since all that need do is create a new list whose head node is the &quot;next&quot; node of the head node of the current list (if the head node of the intial list was null then there are no items, and so RemoveFromStart would be invalid).</p>
<pre><code>public SimplePersistentImmutableList&lt;T&gt; RemoveFirstItem()
{
    if (_head == null)
        throw new InvalidOperationException(&quot;The list is empty&quot;);

    return new SimplePersistentImmutableList&lt;T&gt;(
        _head.Next
    );
}
</code></pre>
<p>At this point, we could very easily take this code and create an immutable stack by renaming &quot;InsertAtStart&quot; to &quot;Push&quot;, &quot;RemoveFromStart&quot; to &quot;Pop&quot; and adding in a way to retrieve the current value, if any:</p>
<pre><code>public T Peek()
{
    if (_head == null)
        throw new InvalidOperationException(&quot;The list is empty&quot;);

    return _head.Value;
}

public bool IsEmpty
{
    get
    {
        return (_head == null);
    }
}
</code></pre>
<p>However, to support the other actions that are expected from a list such as inserting-into and removing-from arbitrary locations we need to consider how to find the appropriate place in the node chain from which to snip out values or insert new ones. Unless these operations are to remove the first item(s) from a list or to add some to the start of the list, only <em>some</em> of the existing chain may be shared between the current and new instances.</p>
<p>For example, to add the value 99 into index 2 of the list that is described by the following node chain</p>
<pre><code>{ 3, { 2, { 1, { 0, null } } } }
</code></pre>
<p>then we'd need to end up with the chain</p>
<pre><code>{ 3, { 2, { 99, { 1, { 0, null } } } } }
</code></pre>
<p>managing to re-use only the last two nodes of the existing chain.</p>
<p>This brings me onto the issue that I have with the above implementation; it's my gut feeling that the majority of operations that I might perform on a list are generating an immutable list from a mutable set, adding items to the end of an existing list and enumerating through the values. Keeping a reference to the head node means that every time a new value is added to the end of the list, none of the chain may be persisted. So to optimise for this operation we can store a reference to the <em>tail</em> of the chain. Now the same logic from the InsertAtStart method becomes the Add method:</p>
<pre><code>public SimplePersistentImmutableList&lt;T&gt; Add(T value)
{
    return new SimplePersistentImmutableList&lt;T&gt;(
        new Node(value, _tail)
    );
}
</code></pre>
<p>so long as the Node class is also altered to reflect this reversed nature:</p>
<pre><code>private class Node
{
    public Node(T value, Node previous)
    {
        Value = value;
        Previous = previous;
    }

    public T Value { get; private set; }

    /// &lt;summary&gt;
    /// This will be null if there is no previous node
    /// &lt;/summary&gt;
    public Node Previous { get; private set; }
}
</code></pre>
<p>This does raise one thorny issue, though; we have to re-think enumeration of the list since we can only step <em>backwards</em> through the list as the &quot;master&quot; node reference we store is the tail. A simple approach would be as follows:</p>
<pre><code>public IEnumerator&lt;T&gt; GetEnumerator()
{
    var values = new List&lt;T&gt;();
    var node = _tail;
    while (_tail != null)
    {
        values.Insert(0, node.Value);
        node = node.Previous;
    }
    return values.GetEnumerator();
}
</code></pre>
<p>This makes enumeration potentially an expensive operation, especially if there are a large number of items in the set since a new List is built and populated for each enumeration. And if there are a lot of items to deal with then the list may have to resize its internal array multiple times (with a copy operation from one array to the next) since we don't know up front how large the list needs to be.</p>
<p>To address this, I'm going to make two changes. Firstly, the Node class will be given a Count property which is always the Count of the previous Node plus one, unless the previous Node is null in which case the Count is one.</p>
<pre><code>private class Node
{
    public Node(T value, Node previous)
    {
        Value = value;
        Previous = previous;
        Count = (previous == null) ? 1 : (previous.Count + 1);
    }

    public T Value { get; private set; }

    /// &lt;summary&gt;
    /// This will be null if there is no previous node
    /// the head)
    /// &lt;/summary&gt;
    public Node Previous { get; private set; }

    public int Count { get; private set; }
}
</code></pre>
<p>Secondly, I'm going to introduce a class member array &quot;_allValues&quot; which is only populated the first time that an enumeration is requested and that effectively caches the value set in an easily-enumerable format. This is only populated &quot;on demand&quot; to avoid any overhead where it is generated for a list that will never be enumerated over (if an instance L0 has a value added to it, resulting in L1, which then has a further value added to it, resulting in L2, we don't want to waste time generating the &quot;_allValues&quot; array for L1 if the reference to L1 is dropped when L2 is created).</p>
<pre><code>/// &lt;summary&gt;
/// For enumerating the values we need to walk through all of the nodes and then reverse the
/// set (since we start with the tail and work backwards). This can be relatively expensive
/// so the list is cached in the &quot;_allValues&quot; member array so that subsequent requests are
/// fast (mightn't be a big deal for a single enumeration of the contents but it could
/// be for multiple calls to the indexed property, for example).
/// &lt;/summary&gt;
private void EnsureAllValuesDataIsPopulated()
{
    if (_allValues != null)
        return;

    // Since we start at the tail and work backwards, we need to reverse the order of the
    // items in values array that is populated here
    var numberOfValues = Count;
    var values = new T[numberOfValues];
    var node = _tail;
    for (var index = 0; index &lt; numberOfValues; index++)
    {
        values[(numberOfValues - 1) - index] = node.Value;
        node = node.Previous;
    }
    _allValues = values;
}
</code></pre>
<p>The Count property of the node allows an array to be initialised of the required size since now we <em>know</em> the required size. The &quot;_allValues&quot; array is set to null in the constructor and this EnsureAllValuesDataIsPopulated method must be called before anything references it (eg. the GetEnumerator method).</p>
<p>There's something potentially a bit hairy in this, though, as the internals of the class are no longer immutable and so could we be open to crazy things happening in multi-threaded scenarios? <a href="http://www.albahari.com/threading/part4.aspx">Joseph Albahari's Advanced Threading article</a> shows a scary first example and Jon Skeet's <a href="http://csharpindepth.com/Articles/General/Singleton.aspx">Implementing the Singleton Pattern in C#</a> has an example with code that looks very similar to what we're doing here, and that's clearly marked as not thread-safe. The first example illustrates how issues may arise as the <em>&quot;compiler, CLR or CPU may <em>reorder</em> your program's instructions to improve efficiency&quot;</em> but <em>&quot;C# and the runtime are very careful to ensure that such optimizations don’t break ordinary single-threaded code&quot;</em> so in this case we needn't worry as there is only one &quot;_allValues&quot; reference being compared to null and then set and no significant rearrangement could be made that wouldn't affect single-threaded processing. In the Singleton example, the issue is that the work could potentially be performed multiple times if multiple threads checked for null before any thread had completed the work and set the &quot;_allValues&quot; reference. For the lock-free reading that be possible result when &quot;_allValues&quot; <em>has</em> been set, I'm happy with the trade-off in this case. (If multiple threads have to do the work of generating the array while they're all clamouring for the &quot;_allValues&quot; data at the same time that's fine since once they finish, subsequent requests will be able to access the pre-generated array with no locking or other complications). If I wasn't happy with it then I'd probably use the .Net 4.0 Lazy&lt;T&gt; construct I've talked about before (see <a href="/check-check-it-out">Check, check it out</a>) but this could potentially add some overhead for each new instance of the immutable list, which I wanted to avoid for instances that will never be enumerated over.</p>
<pre><code>public class PersistentImmutableList&lt;T&gt; : IEnumerable&lt;T&gt;
{
    private readonly Node _tail;
    private T[] _allValues;

    public PersistentImmutableList() : this((Node)null) { }
    public PersistentImmutableList(IEnumerable&lt;T&gt; values)
    {
        if (values == null)
            throw new ArgumentNullException(&quot;values&quot;);

        Node node = null;
        foreach (var value in values)
        {
            if (node == null)
                node = new Node(value, null);
            else
                node = new Node(value, node);
        }
        _tail = node;
    }
    private PersistentImmutableList(Node tail)
    {
        _tail = tail;
    }

    public int Count
    {
        get { return (_tail == null) ? 0 : _tail.Count; }
    }

    public PersistentImmutableList&lt;T&gt; Add(T value)
    {
        return AddRange(new[] { value });
    }

    public PersistentImmutableList&lt;T&gt; AddRange(IEnumerable&lt;T&gt; values)
    {
        if (values == null)
            throw new ArgumentNullException(&quot;values&quot;);

        var node = _tail;
        foreach (var value in values)
            node = new Node(value, _tail);
        return new PersistentImmutableList&lt;T&gt;(node);
    }

    public IEnumerator&lt;T&gt; GetEnumerator()
    {
        // As documented at http://msdn.microsoft.com/en-us/library/system.array.aspx, from
        // .Net 2.0 onward, the Array class implements IEnumerable&lt;T&gt; but this is only
        // provided at runtime so we have to explicitly cast access its generic
        // GetEnumerator method
        EnsureAllValuesDataIsPopulated();
        return ((IEnumerable&lt;T&gt;)_allValues).GetEnumerator();
    }
    IEnumerator IEnumerable.GetEnumerator()
    {
        return GetEnumerator();
    }

    /// &lt;summary&gt;
    /// For enumerating the values we need to walk through all of the nodes and then reverse
    /// the set (since we start with the tail and work backwards). This can be relatively
    /// expensive so the list is cached in the &quot;_allValues&quot; member array so that subsequent
    /// requests are fast (mightn't be a big deal for a single enumeration of the contents
    /// but it could be for multiple calls to the indexed property).
    /// &lt;/summary&gt;
    private void EnsureAllValuesDataIsPopulated()
    {
        if (_allValues != null)
            return;

        // Since we start at the tail and work backwards, we need to reverse the order of
        // the items in values array that is populated here
        var numberOfValues = Count;
        var values = new T[numberOfValues];
        var node = _tail;
        for (var index = 0; index &lt; numberOfValues; index++)
        {
            values[(numberOfValues - 1) - index] = node.Value;
            node = node.Previous;
        }
        _allValues = values;
    }

    private class Node
    {
        public Node(T value, Node previous)
        {
            Value = value;
            Previous = previous;
            Count = (previous == null) ? 1 : (previous.Count + 1);
        }

        public T Value { get; private set; }

        /// &lt;summary&gt;
        /// This will be null if there is no previous node
        /// the head)
        /// &lt;/summary&gt;
        public Node Previous { get; private set; }

        public int Count { get; private set; }
    }
}
</code></pre>
<p>Having a Count property on the Node enables the immutable list to expose a Count property without having to recursively loop through the nodes.</p>
<h3 id="rounding-it-out"><a href="/persistent-immutable-lists#rounding-it-out">Rounding it out</a></h3>
<p>Since we have a &quot;_tail&quot; Node reference and each Node has a Previous property, this Count on the Node represents the number of items in the list up to and including the current Node. So the tail Node's Count is the number of items in the entire list, the Count property on the node before the tail (if any) would have a Count value of one less - indicating the number of Nodes there are one place before the tail Node. I mention this is because I hope it makes the following methods easier to follow!</p>
<pre><code>public PersistentImmutableList&lt;T&gt; InsertAt(T value, int insertAtIndex)
{
    return InsertAt(new[] { value }, insertAtIndex);
}

public PersistentImmutableList&lt;T&gt; InsertAt(IEnumerable&lt;T&gt; values, int insertAtIndex)
{
    if (values == null)
        throw new ArgumentNullException(&quot;values&quot;);
    if (!values.Any())
        return this;
    if ((insertAtIndex &lt; 0) || (insertAtIndex &gt; Count))
        throw new ArgumentOutOfRangeException(&quot;insertAtIndex&quot;);

    // If the insertion is at the end of the list then we can use AddRange and avoid any
    // messing about
    if (insertAtIndex == Count)
        return AddRange(values);

    // Starting with the tail, walk back to the insertion point, recording the values we
    // pass over
    var node = _tail;
    var valuesBeforeInsertionPoint = new T[Count - insertAtIndex];
    for (var index = 0; index &lt; valuesBeforeInsertionPoint.Length; index++)
    {
        valuesBeforeInsertionPoint[index] = node.Value;
        node = node.Previous;
    }

    // Any existing node chain before the insertion point can be persisted and the new
    // value(s) appended
    foreach (var value in values)
        node = new Node(value, node);

    // Finally, add back the values we walked through before to complete the chain
    for (var index = valuesBeforeInsertionPoint.Length - 1; index &gt;= 0; index--)
        node = new Node(valuesBeforeInsertionPoint[index], node);
    return new PersistentImmutableList&lt;T&gt;(node);
}
</code></pre>
<p>To insert into an arbitrary location in the list, we need to walk backwards from the tail to the insertion point and then insert the new value(s) by persisting the rest of the node chain (from the insertion point up to the head) and appending the new values and then the values which we have to walk through to get to the insertion point. The nodes from the tail to the insertion point can not be maintained as their &quot;Previous&quot; chain will not include the new values!</p>
<p>A very similar approach may be taken to removals:</p>
<pre><code>public PersistentImmutableList&lt;T&gt; RemoveAt(int removeAtIndex)
{
    return RemoveRange(removeAtIndex, 1);
}

public PersistentImmutableList&lt;T&gt; RemoveRange(int removeAtIndex, int count)
{
    if (removeAtIndex &lt; 0)
        throw new ArgumentOutOfRangeException(
            &quot;removeAtIndex&quot;,
            &quot;must be greater than or equal zero&quot;
        );
    if (count &lt;= 0)
        throw new ArgumentOutOfRangeException(&quot;count&quot;, &quot;must be greater than zero&quot;);
    if ((removeAtIndex + count) &gt; Count)
        throw new ArgumentException(&quot;removeAtIndex + count must not exceed Count&quot;);

    // Starting with the tail, walk back to the end of the removal range, recording the
    // values we passed over
    var node = _tail;
    var valuesBeforeRemovalRange = new T[Count - (removeAtIndex + count)];
    for (var index = 0; index &lt; valuesBeforeRemovalRange.Length; index++)
    {
        valuesBeforeRemovalRange[index] = node.Value;
        node = node.Previous;
    }

    // Move past the values in the removal range
    for (var index = 0; index &lt; count; index++)
        node = node.Previous;

    // Now add back the values we walked through above to the part of the chain that can be
    // persisted
    for (var index = valuesBeforeRemovalRange.Length - 1; index &gt;= 0; index--)
        node = new Node(valuesBeforeRemovalRange[index], node);
    return new PersistentImmutableList&lt;T&gt;(node);
}
</code></pre>
<p>And really, that's most of the complication out of the way! We can still flesh out a few more properties like an index property:</p>
<pre><code>public T this[int index]
{
    get
    {
        if ((index &lt; 0) || (index &gt;= Count))
            throw new ArgumentNullException(&quot;index&quot;);

        EnsureAllValuesDataIsPopulated();
        return _allValues[index];
    }
}
</code></pre>
<p>and a sort method:</p>
<pre><code>public PersistentImmutableList&lt;T&gt; Sort(IComparer&lt;T&gt; comparison)
{
    if (comparison == null)
        throw new ArgumentNullException(&quot;comparison&quot;);

    EnsureAllValuesDataIsPopulated();
    return new PersistentImmutableList&lt;T&gt;(
        _allValues.OrderBy(x =&gt; x, comparison)
    );
}
</code></pre>
<p>but we're getting down to icing-on-the-cake now.</p>
<h3 id="conclusion"><a href="/persistent-immutable-lists#conclusion">Conclusion</a></h3>
<p>I've enjoyed this little foray and intend to replace that old simple (effective but slow) immutable list I was using before with a version of this code! In existing code that used the previous implementation, there was a measurable performance hit in some loops where lists were being built up in a method before being returned - I rewrote these to use a mutable list internally and return an immutable representation when the work was complete (because of this performance hit). But now I think I could probably get away with using this new immutable list throughout method internals as well! I need to do some profiling of previously-seen trouble areas to be sure, but I get the sneaky feeling that in some of the larger data sets where performance was seen to be taking a hit, this new immutable list variation may work even better than the built-in <em>mutable</em> list. And that, I'm very happy with! :)</p>
<p class="PostTime">Posted at 20:33</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/implementing-f-sharp-inspired-with-updates-for-immutable-classes-in-c-sharp">Implementing F#-inspired &quot;with&quot; updates for immutable classes in C#</a></li><li><a href="/persistent-immutable-lists-extended">Persistent Immutable Lists - Extended</a></li><li><a href="/i-love-immutable-data">I love Immutable Data</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/Immutability" title="12 Posts">Immutability</a></li></ul></div>
            <p class="Comments">
                <a href="/persistent-immutable-lists#disqus_thread" data-disqus-identifier="38">Comments</a>
            </p>
    </div>
    <div class="Content ArchiveByMonth">
        <p class="PostDate">20 November 2012</p><h2 id="the-windbg-blues"><a href="/the-windbg-blues">The WinDbg Blues</a></h2>
<p>To investigate some cpu-off-the-charts hanging issue that refuses to reproduce itself in a local environment in a project I'm involved with I've had to use WinDbg to interrogate a process dump for clues. On the one hand, that all is information is available can seem amazing at times. Other times it's frustrating how primitive it feels compared to poking around with the Visual Studio debugger!</p>
<p>One of the problems I have is that I only do this kind of investigation infrequently so I never quite internalise all the tricks that I need from one time to the next. The first that for some minidumps there seems to be a version mismatch problem with I try to &quot;.loadby sos mscorwks&quot;, resulting in the following error:</p>
<blockquote>
<p>CLRDLL: c:\WINDOWS\Microsoft.NET\Framework\v2.0.50727\mscordacwks.dll:2.0.50727.5448 f:0 doesn't match desired version 2.0.50727.3625 f:0</p>
</blockquote>
<p>The version of the clr on my computer doesn't match that loaded by the process running on the server. One way around this is to copy sos.dll and all msc*.dll files from the server's C:\Windows\Microsoft.Net\Framework64\v2.0.50727 (or equivalent, depending upon windows location and framework version) into a local folder and then load sos with the following: &quot;.load C:\DllsFromServer\SOS.dll&quot;. I must admit, I think I came upon the set of files to load through some trial and error rather than comprehending the full depth of the issue. But it's worked each time I've encountered the issue so far! :)</p>
<h3 id="retrieving-c-struct-values"><a href="/the-windbg-blues#retrieving-c-struct-values">Retrieving C# struct values</a></h3>
<p>Another problem I run into each time is the manner in which struct values needs to be probed. With other types you can just &quot;!do {addr}&quot; (DumpObject) it and nine times out of ten see the properties and values you want, with the occassional &quot;!da {addr}&quot; (DumpArray) thrown in for good measure. But if you try to do this for a struct value you get the cryptic response:</p>
<blockquote>
<p>&lt;Note: this object has an invalid CLASS field&gt; Invalid object</p>
</blockquote>
<p>From what I understand, the type information is not contained at the address that is indicated (my understanding of all this is a bit limited, so if that's less than accurate then please forgive me!). To access its content we need to point the debugger at the type information as well. For a DateTime, we can get this with the following:</p>
<pre><code>!Name2EE * System.DateTime
</code></pre>
<p>This searches all of the loaded assemblies for the specified type and, if located, will report a MethodTable address. This can used with the DumpVC command to look into the DateTime data:</p>
<pre><code>!DumpVC {MethodTableAddr} {addr}
</code></pre>
<p>For DateTimes, the value is represented by a UInt64 which can be translated by C#:</p>
<pre><code>var d = new DateTime(value);
</code></pre>
<p>Alternatively, there is a WinDbg extension that can help with this: sosex (which can be downloaded from <a href="http://www.stevestechspot.com/SOSEXV40NowAvailable.aspx">http://www.stevestechspot.com/SOSEXV40NowAvailable.aspx</a>). Once loaded (by putting the dll into the &quot;winext&quot; folder under the WinDbg installation location and using &quot;.load sosex&quot;) you can:</p>
<pre><code>!mdt System.DateTime {addr}
</code></pre>
<p>Which is much easier!</p>
<p>There is a similar problem with .Net generic nullable types. If you want to look into the state of a nullable int aka &quot;int?&quot; aka &quot;Nullable&lt;int&gt;&quot; you need to look into the type &quot;System.Nullable`1&quot; and then following the above !Name2EE / !DumpVC approach to looking as the &quot;hasValue&quot; and &quot;value&quot; fields.</p>
<p>This only works following some guesswork at that precise &quot;System.Nullable`1&quot; name. It turns out that sosex can also help with this; it can look up type information given a partial name:</p>
<pre><code>!mx System.Nullable*
</code></pre>
<p>This returns clickable links, amongst which are &quot;get_Value&quot; which exposes a MethodTable for retrieving the content with !DumpVC.</p>
<p class="PostTime">Posted at 21:03</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/the-full-text-indexer-automating-index-generation">The Full Text Indexer - Automating Index Generation</a></li><li><a href="/windbg-rides-again">WinDbg Rides Again</a></li><li><a href="/wcf-with-json-and-nullable-types">WCF with JSON (and nullable types)</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/WinDbg" title="2 Posts">WinDbg</a></li></ul></div>
            <p class="Comments">
                <a href="/the-windbg-blues#disqus_thread" data-disqus-identifier="37">Comments</a>
            </p>
    </div>
    <div class="Content ArchiveByMonth">
        <p class="PostDate">14 November 2012</p><h2 id="the-full-text-indexer-token-breaker-and-string-normaliser-variations"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations">The Full Text Indexer - Token Breaker and String Normaliser variations</a></h2>
<p>I've written a few Posts now about the investigative <a href="/the-full-text-indexer">Full Text Indexer</a> project I've been playing with (see also <a href="/the-full-text-indexer-adding-and-subtracting">Updating the Index</a>, <a href="/the-full-text-indexer-going-international">MultiLingual Content</a> and various <a href="/an-englishlanguage-pluralityhandling-string-normaliser">tangents</a> <a href="/optimising-the-pluralityhandling-normaliser">into</a> <a href="/a-pluralityhandling-normaliser-correction">plurality</a> <a href="/compiled-linq-expressions-dont-serialise">handling</a>) but I think I've got at least one more to round it off.</p>
<p>Among the basic components of the Index Generator that determine the manner in which it processes content are (as outlined in that <a href="/the-full-text-indexer">First Indexer Post</a>):</p>
<blockquote>
<h4 id="token-breakers"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#token-breakers">Token Breakers</a></h4>
<p>This example uses a &quot;WhiteSpaceTokenBreaker&quot; which will take the string content from the Content Retrievers and break it into individual words by splitting on whitespace characters. Straight forward!</p>
<h4 id="string-normaliser"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#string-normaliser">String Normaliser</a></h4>
<p>The String Normaliser is essentially an IEqualityComparer<string> and will be used to generate a lookup of tokens and compare them against values passed into the GetMatches method. The DefaultStringNormaliser will remove all punctuation, exchange all non-latin characters for latin equivalents and lower-case them all. For the most basic lookups I had in mind, this does the hard work.</string></p>
</blockquote>
<h3 id="string-normalisers"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#string-normalisers">String Normalisers</a></h3>
<p>There are not many String Normaliser implementations at present, the most basic would be to compare two strings to see if they match. Very simple - but for the use cases I have in mind*, which are largely European languages passages, not very useful. The next step up is a case-insensitive match. Marginally better but there are all sorts of puncuation marks that I might want to ignore - eg. I probably want to consider &quot;James&quot; (the name) to be the same as &quot;James'&quot; (the possessive determiner; er, if my searching for the correct linguistic phrase has led me to the correct one :). I may want to try to ignore differences between accented characters (eg. consider &quot;Jose&quot; to match &quot;José&quot;). If we end up comparing strings that contain whitespace (since there's nothing from forcing all Token Breakers to break on whitespace) then we probably want to normalise the whitespace such that a tab is equivalent to a space is equivalent to a run of multiple spaces.</p>
<p>The <strong>DefaultStringNormaliser</strong> will iron over all of these mentioned cracks by normalising whitespace, removing punctuation characters, replacing accented characters with non-accented equivalents, lower-casing the content and trimming it before yielding the final value for comparison.</p>
<p>The <strong>EnglishPluralityStringNormaliser</strong> will (optionally) wrap another String Normaliser (very feasibly a DefaultStringNormaliser) and then add a further layer of processing to the output so that plurality of terms is ignored; so &quot;cat&quot; and &quot;cats&quot; are considered to match, as are &quot;cactus&quot; and &quot;cactii&quot;, for example. The approach it takes isn't perfect but it gets the job done for the most common cases.</p>
<p>* (The fact that a String Normaliser has to be specified in order to instantiate an IndexGenerator should mean that it would be straight-forward to configure one for uses cases that I <em>didn't</em> specifically have in mind when I wrote it).</p>
<h3 id="token-breakers-1"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#token-breakers-1">Token Breakers</a></h3>
<p>The <strong>WhiteSpaceTokenBreaker</strong> is probably the most obvious implementation, it breaks all content on whitespace and considers each resulting segment to be a token. However, there are a lot of other characters which may constitute a break between words - normally these have whitespace around <em>as well</em> but that relies on the input content following particular formatting rules (like ensuring that commas are <em>always</em> followed by a space). So we also have the <strong>WhiteSpaceExtendingTokenBreaker</strong>. This will replace particular characters with a space before handing off processing to another Token Breaker. It may, for example, specify that all brackets (round, square, curly or triangular) be replaced with whitespace, along with full stops and commas. This is useful for a lot of common content. Note that single quotes would not be replaced since they generally do <em>not</em> indicate the end of a word - eg. &quot;don't&quot; is one word, it should not be split into &quot;don&quot; and &quot;t&quot;. This would rely upon the use of a String Normaliser that ignores punctuation such as single quotes so that &quot;O'Connor&quot; and &quot;OConnor&quot; are considered equivalent.</p>
<p>More interesting variations on the theme are the <strong>PartialMatchingTokenBreaker</strong> and the <strong>ConsecutiveTokenCombiningTokenBreaker</strong>. The first will wrap another Token Breaker and then process each of the resulting tokens by generating all substrings from them that are at least as long as the &quot;minLengthOfPartialMatches&quot; and no longer than the &quot;maxLengthOfPartialMatches&quot; constructor arguments on the class. This provides a simple way to implement &quot;partial word matching&quot; and also illustrates the benefit of returning a &quot;WeightAdjustingToken&quot; set from the Token Breaker; these partial words can be given much less weight when stored in the Index, such that full word matches for content appear much higher in a result set (ordered by match weight aka match quality). A &quot;partialMatchWeightDeterminer&quot; delegate is passed to the constructor and used to calculate the weight of these partial matches.</p>
<p>The <strong>ConsecutiveTokenCombiningTokenBreaker</strong> is essentially the opposite, it will apply a specified Token Breaker against the input content first and then generate additional tokens by combining runs of consecutive tokens. So if a passage contains the words &quot;Gotos considered harmful&quot; then instead of this being broken down into just the set &quot;Gotos&quot;, &quot;considered&quot;, &quot;harmful&quot; it would may also result in (depending upon the maxNumberOfTokens constructor argument) &quot;Gotos considered&quot;, &quot;considered harmful&quot; and &quot;Gotos considered harmful&quot;. Again, greater weights may be assigned to these runs of tokens via the weightMultiplierDeterminer constructor argument (a delegate that returns a weight multipler based upon the number of tokens combined to form the extended token). This would enable the article with the phase &quot;Gotos considered harmful&quot; to be assigned a greater weight than one that has the separate words &quot;Gotos&quot;, &quot;considered&quot; and &quot;harmful&quot; (but not arranged into that particular phrase). This would rely upon a search being performed using the GetPartialMatches method of the index, which breaks up the search term according using a particular Token Breaker, rather than requiring the entire phrase be matched precisely (this is covered briefly towards the end of the first <a href="/the-full-text-indexer">Full Text Indexer</a> post).</p>
<p>The use of these token breakers, whether individually or in combination, will result in more data being stored in the Index (as well as more processing of the input content required in order to generate the index) but offer the benefits that searches can also match content more loosely in some cases while prioritising the best matches in others.</p>
<p><strong>Update (28th March 2013):</strong> The <strong>ConsecutiveTokenCombiningTokenBreaker</strong> is no longer the best way to deal with searches for consecutive terms, there is now a GetConsecutiveMatches extension method for IIndexData that doesn't require the additional (expensive) processing when the index is generated, see <a href="/the-full-text-indexer-source-locations">The Full Text Indexer: Source Locations</a>.</p>
<h2 id="bonus-material-the-indexer-in-action-small-scale-though-it-may-be"><a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#bonus-material-the-indexer-in-action-small-scale-though-it-may-be">Bonus Material: The Indexer in action (small scale, though it may be!)</a></h2>
<p>All of the above is a bit dry and I wanted to include it largely to round out the introductory series to this code. So to make this post marginally more interesting, I thought I'd include the configuration in which I've used it on this blog to implement the site search and the autocomplete facility.</p>
<p>I have the following method which is used to generate Index content for both the site search <em>and</em> the auto-complete functionality. Posts have an integer Id and string Title and Content properties. They also have LastModified and Archive properties which enables the Indexes to be cached in memory and on disk, only rebuilding when content has changed (ie. a new Post has been published, an existing Post has been updated or a Post has been archived).</p>
<p>The bulk of the Index generation is illustrated below with comments around most of the decisions:</p>
<pre><code>private IIndexData&lt;int&gt; GenerateIndexData(
    NonNullImmutableList&lt;Post&gt; posts,
    IStringNormaliser sourceStringComparer)
{
    if (posts == null)
        throw new ArgumentNullException(&quot;posts&quot;);
    if (sourceStringComparer == null)
        throw new ArgumentNullException(&quot;sourceStringComparer&quot;);

    // Define the manner in which the raw content is retrieved from Post title and body
    // - English stop words will only receive 1% the weight when match qualities are
    //   determined than other words will receive
    // - Words in the title will be given 5x the weight of words found in body content
    var englishStopWords = FullTextIndexer.Constants.GetStopWords(&quot;en&quot;);
    var contentRetrievers = new List&lt;ContentRetriever&lt;Post, int&gt;&gt;();
    contentRetrievers.Add(new ContentRetriever&lt;Post, int&gt;(
        p =&gt; new PreBrokenContent&lt;int&gt;(p.Id, p.Title),
        token =&gt; (englishStopWords.Contains(token, sourceStringComparer) ? 0.01f : 1f) * 5f
    ));
    contentRetrievers.Add(new ContentRetriever&lt;Post, int&gt;(
        p =&gt; new PreBrokenContent&lt;int&gt;(p.Id, p.Content),
        token =&gt; englishStopWords.Contains(token, sourceStringComparer) ? 0.01f : 1f
    ));

    // Specify the token breaker
    // - English content will generally break on &quot;.&quot; and &quot;,&quot; (unlike &quot;'&quot; or &quot;-&quot; which
    //   are commonly part of words). Also break on round brackets for written content
    //   but also the other bracket types and other common characters that might
    //   represent word breaks in code content found on the site
    var tokenBreaker = new WhiteSpaceExtendingTokenBreaker(
        new ImmutableList&lt;char&gt;(new[] {
            '&lt;', '&gt;', '[', ']', '(', ')', '{', '}',
            '.', ',', ':', ';', '&quot;', '?', '!',
            '/', '\\',
            '@', '+', '|', '='
        }),
        new WhiteSpaceTokenBreaker()
    );

    // Generate an index using the specified StringNormaliser,
    // - The Post class has an integer Id so a simple IntEqualityComparer (see below)
    //   will do the job fine for the dataKeyComparer
    // - If the search term is matched multiple times in a Post then combine the match
    //   weight in a simple additive manner (hence the weightedValues.Sum() call)
    var indexGenerator = new IndexGenerator&lt;Post, int&gt;(
        contentRetrievers.ToNonNullImmutableList(),
        new IntEqualityComparer(),
        sourceStringComparer,
        tokenBreaker,
        weightedValues =&gt; weightedValues.Sum(),
        new NullLogger()
    );
    return indexGenerator.Generate(posts.ToNonNullImmutableList());
}

[Serializable]
private class IntEqualityComparer : IEqualityComparer&lt;int&gt;
{
    public bool Equals(int x, int y)
    {
        return (x == y);
    }

    public int GetHashCode(int obj)
    {
        return obj;
    }
}
</code></pre>
<p>The generation of the search index is fairly straight-forward, the content on my blog is English with code samples (mostly C#) so I use an EnglishPluralityStringNormaliser that wraps a DefaultStringNormaliser (the PreNormaliserWorkOptions flags specified in the constructor are optimisations described in <a href="/optimising-the-pluralityhandling-normaliser">Optimising the Plurality-Handling Normaliser</a>).</p>
<pre><code>var indexDataForSearching = GenerateIndexData(
    posts,
    new EnglishPluralityStringNormaliser(
        new DefaultStringNormaliser(),
        EnglishPluralityStringNormaliser.PreNormaliserWorkOptions.PreNormaliserLowerCases
        | EnglishPluralityStringNormaliser.PreNormaliserWorkOptions.PreNormaliserTrims
    )
);
</code></pre>
<p>The IIndexData&lt;T&gt; class has a GetAllTokens() method which is useful for the autocomplete functionality but it's <em>not</em> as useful with the above string normaliser as that applies various manipulations to the keys (not only does it normalise word endings for plurality handling but it replaces accented characters and removes punctuation). In order to generate an index that we could extract token data from for an autocomplete list we want to avoid these manipulations. This doesn't exist in the FullTextIndex project, since it's not very useful for the intended search functionality, but as a convenient (and very simple!) example of how to vary the functionality we can use a NonAlteringStrongNormaliser:</p>
<pre><code>[Serializable]
public class NonAlteringStringNormaliser : StringNormaliser
{
    public override string GetNormalisedString(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException(&quot;Null/blank value specified&quot;);

        return value;
    }
}
</code></pre>
<p>This inherits from the abstract StringNormaliser class which <em>is</em> in the FullTextIndexer project and implements the Equals and GetHashCode methods of the IEqualityComparer&lt;string&gt; interface, requiring the derived class to provide the GetNormalisedString(string value) method only.</p>
<p>And from this we can generate an autocomplete word list with a little more work:</p>
<pre><code>var indexDataForAutoCompleteExtended = GenerateIndexData(
    posts,
    new NonAlteringStringNormaliser()
);
var autoCompleteContent = new NonNullOrEmptyStringList(
    indexDataForAutoCompleteExtended.GetAllTokens()
    .Where(token =&gt;
        (token.Length &gt;= 3) &amp;&amp;
        !char.IsPunctuation(token[0])
        &amp;&amp; !token.Any(c =&gt; char.IsNumber(c))
    )
    .Distinct(StringComparer.InvariantCultureIgnoreCase)
    .Where(token =&gt; indexDataForSearching.GetMatches(token).Any())
    .OrderBy(token =&gt; token.ToLower())
);
</code></pre>
<p>The filters applied here were determined by running this against the blog content at the time and making up some rules that seemed like they made the resulting data look better (yes, as scientific as that! :) It ignores words less than three characters as these are usually stop words (I considered ignoring <em>all</em> stop words but some of the words in the stop word list seemed like things people <em>might</em> search on). If there are multiple tokens that are variations of each other with differing case then only one of them will be in the final list. Only tokens that actually result in matches in the &quot;indexDataForSearching&quot; content that was generated are included - this should always be the case for the string normaliser I'm currently using but if I tweak that in the future then I want to ensure that I don't end up with tokens being generated for the autocomplete list that don't actually match any Posts!</p>
<p>It's worth noting that the autocomplete list generated is really more like a &quot;suggested&quot; words list since it can't cover every single match. If, for example, the input data contained the word &quot;cats&quot; but not &quot;cat&quot; then the plurality-handling string normaliser used in the search data generation will match the search term &quot;cat&quot; to the word &quot;cats&quot; in the content, but the autocomplete word list would <em>not</em> contain the word &quot;cats&quot; since that wasn't in the source content (though the word &quot;cat&quot; <em>would</em> be, as it <em>was</em> in the content). In practice, I don't see this being a problem as the search box on this site allows you to enter anything - you aren't restricted to only words in the autocomplete list.</p>
<p>Finally, everything has been declared serialisable so that the index data could be cached on disk. In practice, this means that I build the index data locally when I update a Post and view it on my local computer - and then I upload the new content along with the on-disk index content so that searches performed on the site should be fast as soon as all this new data is uploaded.</p>
<p><strong>Update (17th December 2012):</strong> This has been included as part of a later <a href="/the-full-text-indexer-post-roundup">Full Text Indexer Round-up Post</a> that brings together several Posts into one series, incorporating code and techniques from each of them.</p>
<p class="PostTime">Posted at 19:12</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/a-pluralityhandling-normaliser-correction">A Plurality-Handling Normaliser Correction</a></li><li><a href="/optimising-the-pluralityhandling-normaliser">Optimising the Plurality-Handling Normaliser</a></li><li><a href="/an-englishlanguage-pluralityhandling-string-normaliser">An English-language Plurality-handling String Normaliser</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/FullTextIndexer" title="17 Posts">FullTextIndexer</a></li></ul></div>
            <p class="Comments">
                <a href="/the-full-text-indexer-token-breaker-and-string-normaliser-variations#disqus_thread" data-disqus-identifier="36">Comments</a>
            </p>
    </div>
    <div class="Content ArchiveByMonth">
        <p class="PostDate">9 November 2012</p><h2 id="consuming-a-wcf-web-service-from-php"><a href="/consuming-a-wcf-web-service-from-php">Consuming a WCF Web Service from PHP</a></h2>
<p>For the Web Service that I've been developing at work, I was asked to support a Developer who was trying to consume it for a project. The problem being that he was developing in PHP and had never connected to a .Net Web Service before - at least not knowingly; the APIs he'd integrated with before would all communicate in JSON. The other half of the problem is that I've never developed anything in PHP! In fact I'd not written a line in my life before last week.</p>
<p>From what I'm led to understand of PHP it's somewhat of a mess of 1000s of functions with inconsistent names, signatures and approaches. It's dynamically typed and may or may not have namespaces in any usable manner. But it's got an enormous set of well-established libraries available for everything under the sun. So this should be a walk in the park, right??</p>
<p>Below is a simplified version of what we're working with; the idea that you could search for Hotels that meet various criteria, where the criteria can be built up with the application of multiple Filters - at least one must be specified but multiple may be, in which case Hotels must meet the criteria in all Filters in order to be returned.</p>
<pre><code>[ServiceContract]
public class HotelService
{
    [OperationContract]
    public Hotel[] GetHotels(HotelSearchRequest request)
    {
        ..
    }
}

[DataContact]
public class HotelSearchRequest
{
    [DataMember]
    public string APIKey { get; set; }

    [DataMember]
    public Filter[] Filters { get; set; }
}

[KnownType(CategoryFilter)]
[KnownType(ProximityFilter)]
[DataContract]
public abstract class Filter { }

[DataContract]
public class CategoryFilter : Filter
{
    [DataMember]
    public int[] CategoryKeys { get; set; }
}

[DataContract]
public class ProximityFilter : Filter
{
    [DataMember]
    public CoordinateDetails Centre { get; set; }

    [DataMember(IsRequired = true)]
    public int MaxDistanceInMetres { get; set; }
}
</code></pre>
<p>We have to mess about a bit with KnownType declarations in the right place in the service contract but once that's all sorted the service is easy to consume from a .Net WCF Client, all of the inheritance is easily understood (as they're documented in the xsd that the service exposes) and queries are easy to construct.</p>
<p>Getting things working in PHP is another matter, however. For someone who doesn't know what he's doing, at least! All of the basic examples suggest something along the lines of:</p>
<pre><code>$client = new SoapClient(
    &quot;http://testhotelservice.com/HotelService.svc?wsdl&quot;,
    array(&quot;trace&quot; =&gt; 1)
);
$data = $client-&gt;GetHotels(
    array(
        &quot;request&quot; =&gt; array(
            &quot;ApiKey&quot; =&gt; &quot;{KeyGoesHere}&quot;,
            &quot;Filters&quot; =&gt; array(
                // TODO: What to write here?!
            )
        )
    )
);
</code></pre>
<p>It seems like the SoapClient can do some sort of magic with what are presumably associative arrays to build up the web request. All looks good initially for declaring data for the &quot;request&quot; argument of the GetHotels method; we set the &quot;ApiKey&quot; property of the request to an appropriate string.. the SoapClient must be doing something clever with the wsdl to determine the xml to generate, which must include the type name of the request to specify. But if the type names are intended to be hidden, how am I going to specify them when I build the &quot;Filters&quot; array?? I can't just carry on with this type-name-less associated-array approach because there will be no way for the request to know that I want the CategoryFilter or the ProximityFilter (or any other Filter that might be available).</p>
<p>Hmmm...</p>
<p>More googling brings me to discover the SoapVar class for use with the SoapClient. If we do the following:</p>
<pre><code>$client = new SoapClient(
    &quot;http://testhotelservice.com/HotelService.svc?wsdl&quot;,
    array(&quot;trace&quot; =&gt; 1)
);
$data = $client-&gt;GetHotels(
    array(
        &quot;request&quot; =&gt; array(
            &quot;ApiKey&quot; =&gt; &quot;{KeyGoesHere}&quot;,
            &quot;Filters&quot; =&gt; array(
                new SoapVar(
                    array(
                        &quot;CategoryKeys&quot; =&gt; array(1, 2, 3)
                    ),
                    SOAP_ENC_OBJECT,
                    &quot;CategoryFilter&quot;,
                    &quot;http://schemas.datacontract.org/2004/07/DemoService.Messages.Requests&quot;
                )
            )
        )
    )
);
</code></pre>
<p>Then we <em>are</em> able to include information about the type. Progress! The namespace string specified references the C# namespace of the CategoryFilter class.</p>
<p>As with so many things, it looks all so easy. But I didn't know what exactly I should be searching for, getting this far took me quite a while - and the resource out there explaining this are thin on the ground! With the maturity of both PHP and WCF I would have thought that information about calling into WCF Services from PHP in this manner would be much readily available!</p>
<h3 id="but-wait-theres-more"><a href="/consuming-a-wcf-web-service-from-php#but-wait-theres-more">But wait; there's more</a></h3>
<p>While I was at it, I thought I'd dig a little further. When I first communicated with this other Developer, I asked him to send me a trace of the requests that were being generated by his PHP code, using Fiddler or something. This information was not forthcoming and when I was running test PHP scripts on my local machine the requests weren't being captured by Fiddler anyway. But I found these handy methods:</p>
<pre><code>$client-&gt;__getLastRequest()
$client-&gt;__getLastRequestHeaders()
</code></pre>
<p>which will retrieve the sent content, ideal for looking into exactly what messages were being generated! These only work if the &quot;trace&quot; =&gt; &quot;1&quot; argument is specified when the SoapClient is instantiated. Which explained to me what that was for, which was nice :)</p>
<h3 id="enabling-gzip-support"><a href="/consuming-a-wcf-web-service-from-php#enabling-gzip-support">Enabling gzip support</a></h3>
<p>The next issue I had was another one that I thought would be beyond easy to solve, with easy-to-follow and accurate information all over the place. I was wrong again! At least, my first searches didn't bring me immediately to the answer :(</p>
<p>A <em>lot</em> of resources suggest the following:</p>
<pre><code>$client = new SoapClient(
    &quot;http://testhotelservice.com/HotelService.svc?wsdl&quot;,
    array(
        &quot;compression&quot; =&gt; SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | 9,
        &quot;trace&quot; =&gt; 1
    )
);
</code></pre>
<p>and some suggest this variation (quoting the compression value):</p>
<pre><code>$client = new SoapClient(
    &quot;http://testhotelservice.com/HotelService.svc?wsdl&quot;,
    array(
        &quot;compression&quot; =&gt; &quot;SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | 9&quot;,
        &quot;trace&quot; =&gt; 1
    )
);
</code></pre>
<p>These do <em>not</em> work. The first results in a &quot;can't uncompress compressed response&quot; after a delay which makes me think that it's doing work. The latter does cause any error but also doesn't include the &quot;Accept-encoding: gzip&quot; HTTP header that I'm looking for.</p>
<p>They both <em>feel</em> wrong, anyway; presumably the 9 relates to gzip compression level 9. The compression level should surely be set on the server only, not referenced by the client?? And what <em>are</em> these SOAP_COMPRESS_ACCEPT and SOAP_COMPRESSION_GZIP values? These values are just numeric constants, it turns out, which are OR'd together in the first variation. But what's the 9 for; is it supposed to be there at all; is it some other mystery constant?? And surely the quoted version is incorrect unless PHP has some mad string rules that I don't know about (totally possible with my knowledge of PHP but not the case here! :)</p>
<p>The correct version is simply:</p>
<pre><code>$client = new SoapClient(
    &quot;http://testhotelservice.com/HotelService.svc?wsdl&quot;,
    array(
        &quot;compression&quot; =&gt; SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP,
        &quot;trace&quot; =&gt; 1
    )
);
</code></pre>
<p>Again, oh so simple yet so much harder to come to in the end than it should have been.</p>
<h3 id="one-more-thing"><a href="/consuming-a-wcf-web-service-from-php#one-more-thing">One more thing</a></h3>
<p>A final note, that actually <em>was</em> commonly documented and pointed out, was that if you are developing against a service that is still in flux that you should disable wsdl caching in PHP. This will affect performance as the wsdl will be retrieved on each request (I presume), but it may prevent some headaches if the contract changes. I changed a value in the php.ini file but apparently it can also be done in the PHP script with:</p>
<pre><code>ini_set(&quot;soap.wsdl_cache_enabled&quot;, 0);
</code></pre>
<p>(Courtesy of a <a href="http://stackoverflow.com/a/303514">StackOverflow answer</a>).</p>
<h3 id="conclusion"><a href="/consuming-a-wcf-web-service-from-php#conclusion">Conclusion</a></h3>
<p>This may well be simple stuff to the real PHP developers out there but since I struggled, maybe this post will help others in the future with this particular problem!</p>
<p class="PostTime">Posted at 23:03</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/why-do-you-hate-my-wcf-types-php">Why do you hate my (WCF) types, PHP??</a></li><li><a href="/ramping-up-wcf-web-service-request-handling-on-iis-6-with-net-40">Ramping up WCF Web Service Request Handling.. on IIS 6 with .Net 4.0</a></li><li><a href="/dependency-injection-with-a-wcf-service">Dependency Injection with a WCF Service</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/WCF" title="6 Posts">WCF</a></li><li><a href="/Archive/Tag/PHP" title="2 Posts">PHP</a></li></ul></div>
            <p class="Comments">
                <a href="/consuming-a-wcf-web-service-from-php#disqus_thread" data-disqus-identifier="35">Comments</a>
            </p>
    </div>

        <script type="text/javascript">
            (function () {
                var s = document.createElement("script");
                s.type = "text/javascript";
                s.async = true;
                s.src = "https://" + disqus_shortname + ".disqus.com/count.js";
                (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
            }());
        </script>

				<div class="Footer">
					© Productive Rage 2011 - 2022
				</div>
			</div>

			<div class="SideBar">
				<div class="About">
					<h2>About</h2>
					<p>Dan is a big geek who likes making stuff with computers! He can be quite outspoken so clearly needs a blog :)</p>
					<p>In the last few minutes he seems to have taken to referring to himself in the third person. He's quite enjoying it.</p>
					<p><a href="mailto:dangger36@gmail.com" class="Email">dangger36@gmail.com</a></p>
				</div>
				<div class="Search">
<form action="/Search" autocomplete="off" class="Search" method="get">						<div>
							<label class="SearchField">
								<span class="text">Site Search</span>
								<input type="text" class="SiteSearch" name="term" value="" />
							</label>
							<input type="submit" class="SiteSearchSubmit" value="Search" />
						</div>
</form>				</div>
				<div class="Recent"><h2>Recent Posts</h2><ul><li><a href="/so-what-is-machine-learning-nocodeintro">So.. what is machine learning? (#NoCodeIntro)</a></li><li><a href="/parallelising-linq-work-in-c-sharp">Parallelising (LINQ) work in C#</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts-part-2">Automating &quot;suggested / related posts&quot; links for my blog posts - Part 2</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts">Automating &quot;suggested / related posts&quot; links for my blog posts</a></li><li><a href="/language-detection-and-wordsinsentence-classification-in-c-sharp">Language detection and words-in-sentence classification in C#</a></li></ul><div class="RSSFeedLink"><a href="https://www.productiverage.com/feed">RSS Feed</a></div></div>
				<div class="Featured"><h2>Highlights</h2><ul><li><a href="/face-or-no-face-finding-faces-in-photos-using-c-sharp-and-accordnet">Face or no face (finding faces in photos using C# and Accord.NET)</a></li><li><a href="/when-a-disk-cache-performs-better-than-an-inmemory-cache-befriending-the-net-gc">When a disk cache performs better than an in-memory cache (befriending the .NET GC)</a></li><li><a href="/performance-tuning-a-bridgenet-react-app">Performance tuning a Bridge.NET / React app</a></li><li><a href="/creating-a-c-sharp-roslyn-analyser-for-beginners-by-a-beginner">Creating a C# (&quot;Roslyn&quot;) Analyser - For beginners by a beginner</a></li><li><a href="/translating-vbscript-into-c-sharp">Translating VBScript into C#</a></li><li><a href="/entity-framework-projections-to-immutable-types-ienumerable-vs-iqueryable">Entity Framework projections to Immutable Types (IEnumerable vs IQueryable)</a></li></ul></div>
				<div class="History"><h2>Archives</h2><ul><li><a href="/Archive/2/2022">February 2022 (1)</a></li><li><a href="/Archive/8/2021">August 2021 (1)</a></li><li><a href="/Archive/4/2021">April 2021 (2)</a></li><li><a href="/Archive/3/2021">March 2021 (1)</a></li><li><a href="/Archive/8/2020">August 2020 (3)</a></li><li><a href="/Archive/7/2019">July 2019 (2)</a></li><li><a href="/Archive/9/2018">September 2018 (1)</a></li><li><a href="/Archive/4/2018">April 2018 (1)</a></li><li><a href="/Archive/3/2018">March 2018 (1)</a></li><li><a href="/Archive/7/2017">July 2017 (1)</a></li><li><a href="/Archive/6/2017">June 2017 (1)</a></li><li><a href="/Archive/2/2017">February 2017 (1)</a></li><li><a href="/Archive/11/2016">November 2016 (1)</a></li><li><a href="/Archive/9/2016">September 2016 (2)</a></li><li><a href="/Archive/8/2016">August 2016 (1)</a></li><li><a href="/Archive/7/2016">July 2016 (1)</a></li><li><a href="/Archive/6/2016">June 2016 (1)</a></li><li><a href="/Archive/5/2016">May 2016 (3)</a></li><li><a href="/Archive/3/2016">March 2016 (3)</a></li><li><a href="/Archive/2/2016">February 2016 (2)</a></li><li><a href="/Archive/12/2015">December 2015 (1)</a></li><li><a href="/Archive/11/2015">November 2015 (2)</a></li><li><a href="/Archive/8/2015">August 2015 (3)</a></li><li><a href="/Archive/7/2015">July 2015 (1)</a></li><li><a href="/Archive/6/2015">June 2015 (1)</a></li><li><a href="/Archive/5/2015">May 2015 (2)</a></li><li><a href="/Archive/4/2015">April 2015 (1)</a></li><li><a href="/Archive/3/2015">March 2015 (1)</a></li><li><a href="/Archive/1/2015">January 2015 (2)</a></li><li><a href="/Archive/12/2014">December 2014 (1)</a></li><li><a href="/Archive/11/2014">November 2014 (1)</a></li><li><a href="/Archive/10/2014">October 2014 (2)</a></li><li><a href="/Archive/9/2014">September 2014 (2)</a></li><li><a href="/Archive/8/2014">August 2014 (1)</a></li><li><a href="/Archive/7/2014">July 2014 (1)</a></li><li><a href="/Archive/6/2014">June 2014 (1)</a></li><li><a href="/Archive/5/2014">May 2014 (2)</a></li><li><a href="/Archive/2/2014">February 2014 (1)</a></li><li><a href="/Archive/1/2014">January 2014 (1)</a></li><li><a href="/Archive/12/2013">December 2013 (1)</a></li><li><a href="/Archive/11/2013">November 2013 (1)</a></li><li><a href="/Archive/10/2013">October 2013 (1)</a></li><li><a href="/Archive/8/2013">August 2013 (3)</a></li><li><a href="/Archive/7/2013">July 2013 (3)</a></li><li><a href="/Archive/6/2013">June 2013 (1)</a></li><li><a href="/Archive/5/2013">May 2013 (2)</a></li><li><a href="/Archive/4/2013">April 2013 (1)</a></li><li><a href="/Archive/3/2013">March 2013 (8)</a></li><li><a href="/Archive/2/2013">February 2013 (2)</a></li><li><a href="/Archive/1/2013">January 2013 (2)</a></li><li><a href="/Archive/12/2012">December 2012 (3)</a></li><li><a href="/Archive/11/2012">November 2012 (4)</a></li><li><a href="/Archive/9/2012">September 2012 (1)</a></li><li><a href="/Archive/8/2012">August 2012 (1)</a></li><li><a href="/Archive/7/2012">July 2012 (3)</a></li><li><a href="/Archive/6/2012">June 2012 (3)</a></li><li><a href="/Archive/5/2012">May 2012 (2)</a></li><li><a href="/Archive/2/2012">February 2012 (3)</a></li><li><a href="/Archive/1/2012">January 2012 (4)</a></li><li><a href="/Archive/12/2011">December 2011 (7)</a></li><li><a href="/Archive/8/2011">August 2011 (2)</a></li><li><a href="/Archive/7/2011">July 2011 (1)</a></li><li><a href="/Archive/5/2011">May 2011 (1)</a></li><li><a href="/Archive/4/2011">April 2011 (2)</a></li><li><a href="/Archive/3/2011">March 2011 (3)</a></li></ul><div class="EveryTitle"><a href="/Archive/All">Every Post Title</a></div></div>
			</div>

		</div>
	</div>

	<script type="text/javascript" src="/Scripts/autocomplete.js"></script>
	<script type="text/javascript" src="/Scripts/prettify.js"></script>
	<script type="text/javascript" src="/Scripts/Site.js"></script>
	<script type="text/javascript" src="/Scripts/IndexSearchGenerator.js"></script>
	<script type="text/javascript" src="/Scripts/SearchTermHighlighter.js"></script>
	<script type="text/javascript" src="/Scripts/SearchPage.js"></script>
	<script type="text/javascript" src="/Scripts/LZString.js"></script>

</body>
</html>
