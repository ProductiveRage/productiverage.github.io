<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title>Productive Rage - Monitoring my garden&#x27;s limited sunlight time period with an Arduino (and some tupperware)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#393939" />
	<link rel="stylesheet" type="text/css" media="all" href="/Content/Styles.css" />
	<!--[if lt IE 9]>
	<link rel="stylesheet" type="text/css" href="/Content/IEBefore9.css" />
	<![endif]-->
	<link rel="stylesheet" type="text/css" media="print" href="/Content/PrintOverrides.css" />
	<link rel="canonical" href="http://www.productiverage.com/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware" />
	<link rel="shortcut icon" href="/favicon.ico" />
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.productiverage.com/feed" />
	<script type="text/javascript">
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', "UA-32312857-1", { 'storage': 'none' });
		ga('send', 'pageview');
	</script>
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="productiverage" />
    <meta name="twitter:title" content="Monitoring my garden&#x27;s limited sunlight time period with an Arduino (and some tupperware)" />
    <meta name="twitter:image" content="http://www.productiverage.com/Content/Images/Grouch.jpg" />
    <meta name="twitter:description" content="My house has a lovely little garden out front. The house and garden itself are elevated one storey above the street (and so my basement is really more of a bizarre ground floor because it has.." />
</head>

<body>

	<div class="Header">
		<div class="HeaderContent">
			<h1>
				<a href="/">Productive Rage</a>
			</h1>
			<span class="Tagline">Dan's techie ramblings</span>
		</div>
	</div>

	<div class="WrapperOuter">
		<div class="Wrapper">
			<div class="Main HasSideBar">
				

        <script type="text/javascript">
			var disqus_shortname = "productiverage";
			function executeWhen(fncAction, fncConditional, intDelayBetweenRetries) {
				if (fncConditional()) { fncAction(); return; }
				setTimeout(function () { executeWhen(fncAction, fncConditional, intDelayBetweenRetries); }, intDelayBetweenRetries);
			}
			function whenjQueryIsAvailable(fncAction) {
				executeWhen(
					fncAction,
					function () { return (typeof ($) !== "undefined") },
					10
				);
			}
			(function () {
				whenjQueryIsAvailable(
					function () { $("div.Content p.Comments").show(); }
				);
			}());
        </script>

    <div class="Content SinglePost">
        <h3 class="PostDate">22 August 2020</h3><h2><a id="monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware" href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware">Monitoring my garden's limited sunlight time period with an Arduino (and some tupperware)</a></h2>
<p>My house has a lovely little garden out front. The house and garden itself are elevated one storey above the street (and so my basement is really more of a bizarre ground floor because it has natural light windows but is full of dust and my life-accumulated rubbish is in one room of it while my covid-times &quot;trying to stay fit, not fat&quot; home gym is in the other) and there was no fence around it when I moved in. Meaning that that the <em>interesting characters</em> that amble past (suffice to say that I went for a nicer house in a slightly on-the-cusp between classy and rougher neighbourhoods as opposed to a less nice house in a posh place) could see in and converse between sips on their 9am double-strength lager. Once fenced off, kitted out with a cute little table and chairs that my friendly neighbours found at a tip and with some lovely raised flower beds installed, it is a <em>delight</em> in Summer.. only problem is that my house faces the wrong way and so only gets direct sunlight at certain hours of the day. And this time period varies greatly depending upon the time of year - in March, it might not get the light until almost 5pm whilst in July and August it's getting warm and light and beautiful (well, on the days that English weather allows) more in time for a late lunch.</p>
<p>The problem is that, even after four years here, I still don't really have any idea when it's going to be sunny there for a given time of year and I want to be able to plan opportunities around it - late evening drinks outside with friends, lunch time warm weather meals for myself, just any general chance top up my vitamin D!</p>
<img alt="Rare English sun in my garden (plus cats)" src="/Content/Images/Posts/SunnyGardenAndCats.jpg" class="NoBorder AlwaysFullWidth" />
<p>I guess that one way to sort this out would be to just keep an eye out on sunny days and take the opportunity whenever it strikes. A more organised plan would be to start a little diary and mark down every fortnight or so through the year when the sun hits the garden and when it leaves.</p>
<p>But I work in technology, damnnit, and so I expect to be able to solve this using that electronics and magic! (Cue comments about everything looking like a nail when you're holding a hammer).</p>
<p>To be <em>really</em> honest, maybe I'm describing this situation back to front. My friend gave me an <a href="https://store.arduino.cc/arduino-uno-rev3">Arduino UNO r3</a> because he had a kit spare from the coding club that he runs for kids locally and I'd been looking for a use for it.. and this seemed like it!</p>
<h3>What I needed</h3>
<p>Being a total Arduino noob (and, since my Electronics GCSE was over 20 years ago now, I'm basically a total hardware noob.. you should have seen the trouble that I had trying to build a custom PC a few years ago; I swear it was easier when I was 14!) I wanted something nice and simple to begin with.</p>
<p>So I had the starter kit, which included the Arduino board and some jumper cables, a prototyping breadboard and some common components (including, essentially, a photoresistor) and so I figured that all I'd then need is a way to record the light levels periodically, a power source and some sort of container for when it rains (again; England).</p>
<p>I considered having some sort of fancy wifi server in it that would record the values somehow and let me either poll it from somewhere else or have it push those results to the cloud somewhere but eventually decided to go for what seemed like a simpler, more robust and (presumably) more power efficient mechanism of storing the light values throughout the day - using an SD card. Because I'd got the kit for free (on the agreement that I would try to do something useful with it), I was looking for something cheap to write to an SD card that I'd had lying around since.. well, I guess since whenever SD cards were useful. Could it have been a digital camera? The very concept seems absurd these days, with the quality of camera that even phones from three or four generations ago have.</p>
<p>I came across something called a &quot;<strong>Deek Robot SD/RTC datalogging shield</strong>&quot; that would not only write to an SD card but would also keep time due to a small battery mounted on it.</p>
<p>These are cheap (mine was less than £5 delivered, new from eBay) but documentation is somewhat.. spotty. There is a lot of documentation for the &quot;Adafruit Assembled Data Logging shield&quot; but they cost more like £13+ and I was looking for the cheap option. Considering how much time I spent trying to make it work and find good information, it probably would have made more sense to buy a better supported shield than a knock-off from somewhere.. but I <em>did</em> get it working eventually, so I'll share all the code throughout this post!</p>
<img alt="The Arduino UNO r3 with a Deek Robot SD/RTC shield installed" src="/Content/Images/Posts/ArduinoAndShield.jpg" class="NoBorder AlwaysFullWidth" />
<p><em>Note: I found a warning that when using this particular shield, &quot;If you have a UNO with a USB type B connector this shield may NOT WORK because the male pins are NOT LONG ENOUGH&quot; on a <a href="https://forum.arduino.cc/index.php?topic=649395.0">forum page</a> - my UNO r3 does have the USB B connector but I've not had this problem.. though if you do encounter this problem then maybe some sort of pin extenders or raisers would fix it.</em></p>
<h3>Step 1: Writing to the SD card</h3>
<p>After reading around, I settled on a library called <a href="https://github.com/greiman/SdFat">SdFat</a> that should handle the disk access for me. I downloaded it from the Github repo and followed the &quot;Importing a .zip Library&quot; instructions on the <a href="https://www.arduino.cc/en/guide/libraries">Installing Additional Arduino Libraries</a> page.</p>
<p>This allowed me to stack the data logging shield on top of the UNO, put an SD card into the shield, connect the UNO to my PC via a USB lead and upload the following code -</p>
<pre><code>#include &lt;SdFat.h&gt; // https://github.com/greiman/SdFat

// chipSelect = 10 according to &quot;Item description&quot; section of
// https://www.play-zone.ch/de/dk-data-logging-shield-v1-0.html
#define SD_CHIP_SELECT 10

void setup() {
  Serial.begin(9600);

  // See &quot;Note 1&quot; further down about SPI_HALF_SPEED
  SdFat sd;
  if (!sd.begin(SD_CHIP_SELECT, SPI_HALF_SPEED)) {
    Serial.println(&quot;ERROR: sd.begin() failed&quot;);
  }
  else {
    SdFile file;
    if (!file.open(&quot;TestData.txt&quot;, O_WRITE | O_APPEND | O_CREAT)) {
      Serial.println(&quot;ERROR: file.open() failed - unable to write&quot;);
    }
    else {
      file.println(&quot;Hi!&quot;);
      file.close();
      Serial.println(&quot;Successfully wrote to file!&quot;);
    }
  }
}

void loop() { }
</code></pre>
<p>The Arduino IDE has an option to view the serial output (the messages written to &quot;Serial.println&quot;) by going to Tools / Serial Monitor. Ensure that the baud rate shown near the bottom right of the window is set to 9600 to match the setting in the code above.</p>
<p>This happily showed</p>
<blockquote>
<p>Successfully wrote to file!</p>
</blockquote>
<p>in the Serial Monitor's output and when I yanked the card out and put it into my laptop to see if it had worked, it did indeed have a file on it called &quot;TestData.txt&quot; with a single line saying &quot;Hi!&quot; - an excellent start!</p>
<p><em>Note 1: In the &quot;sd.begin&quot; call, I specify <strong>SPI_HALF_SPEED</strong> primarily because that's what most of the examples that I've found use - there is an option <strong>SPI_FULL_SPEED</strong> but I read in <a href="https://community.particle.io/t/has-anyone-had-success-hooking-up-an-sd-card-to-the-photon-and-writing-reading-data/24026/41">an Arduino forum thread</a> that: &quot;You should be able to use <strong>SPI_FULL_SPEED</strong> instead, but if that produces communication errors you can use SD_SCK_HZ(4 * MHZ) instead of <strong>SPI_HALF_SPEED</strong>&quot; and I'm not sure what might be the limiting factor with said communication errors; whether it's the card or the shield or something else and I'm only going to be writing small amounts of data at relatively infrequent intervals and so I thought that I would err on the safe side and stick with <strong>SPI_HALF_SPEED</strong>.</em></p>
<p><em>Note 2: In a lot of code samples, in the &quot;setup&quot; method you will see code after the &quot;Serial.begin(..)&quot; call that looks like this:</em></p>
<pre><code>while (!Serial) {
  // wait for serial port to connect - needed for native USB
}
</code></pre>
<p><em>^ This is only needed for particular variants of the Arduino - the &quot;Leonardo&quot;, I believe - and is not required for the UNO and so I haven't included it in my code.</em></p>
<p><strong>Gotcha One:</strong> Initially, I had formatted my SD card (branded as &quot;Elgetec&quot;, who I can't remember ever hearing of other than on this card) on my Windows laptop - doing a full format, to make absolutely sure that it was as ready for action as possible. However, not only did that full format take a long time, I found that when I left my Arduino shield writing files over a period of a few hours then it would often get reported as being corrupted when I tried to read it. I've found that if the <a href="https://github.com/greiman/SdFat/blob/master/examples/SdFormatter/SdFormatter.ino">SdFormatter.ino</a> (from the examples folder of the SdFat GitHub repo) is used then these corruption problems have stopped occurring (and the formatting is much faster!).</p>
<p><strong>Gotcha Two:</strong> While I was fiddling around with writing to the SD card, particularly when connected to a battery instead of the USB port (where I could use the Serial Monitor to see what was happening), I tried setting the LED_BUILTIN to be on while writing and then go off again when the file was closed. This didn't work. And it <em>can't</em> work, though it took me a lot of reading to find out why. It turns out that the SPI (the <a href="https://www.arduino.cc/en/reference/SPI">Serial Peripheral Library</a>) connection from the Arduino to the Deek Robot shield will use IO pins 10, 11, 12 and 13 for its own communications. 13 happens to be the output used to set the LED_BUILTIN state and so you lose access to setting that built-in LED while this shield is connected. Specifically, &quot;<a href="https://forum.arduino.cc/index.php?topic=533606.msg3637549#msg3637549">pin 13 is the SPI clock. Pin 13 is also the built-in led and hence you have a conflict</a>&quot;.</p>
<h3>Step 2: Keeping time</h3>
<p>Since I want to record light levels throughout the day, it's important to know at what time the recording is being made. The shield that I'm using also includes an &quot;RTC&quot; (a real-time clock) and so I needed to work out how to set that once and then read from it each time I took a light level reading.</p>
<p>The UNO board itself can do some basic form of time keeping, such as telling you how long it's been since the board started / was last reset (via the <a href="https://www.arduino.cc/reference/en/language/functions/time/millis/">millis()</a> function) but there are a few limitations with this. You can bake into the compiled code the time at which it was compiled and you <em>could</em> then use that, in combination with &quot;millis()&quot;, to work out the current time but you will hit problems if power is temporarily lost or if the board is reset (because &quot;millis()&quot; will start from zero again and timing will start again from that baked-in &quot;compiled at&quot; time).</p>
<p><strong>Gotcha Three:</strong> I didn't realise when I was first fiddling with this that any time you connected the USB lead, it would reset the board and the program (the &quot;sketch&quot;, in Arduino-speak) would start all over again. (This will only make a difference if you're using an external power source because otherwise the program would <em>stop</em> whenever you disconnected the USB lead and there would be nothing running to reset when plugging the USB lead back in! I'll be talking about external power supplies further down).</p>
<p>So the next step was using the clock on the shield that I had bought, instead of relying on the clock on the Arduino board itself. To do this, I'd inserted a CR1220 battery and then tested with the following code:</p>
<pre><code>#include &lt;Wire.h&gt;
#include &lt;RTClib.h&gt; // https://github.com/adafruit/RTClib

RTC_DS1307 rtc;

void setup() {
  // The clock won't work with this (thanks https://arduino.stackexchange.com/a/44305!)
  Wire.begin();

  bool rtcWasAlreadyConfigured;
  if (rtc.isrunning()) {
    rtcWasAlreadyConfigured = true;
  }
  else {
    rtc.adjust(DateTime(__DATE__, __TIME__));
    rtcWasAlreadyConfigured = false;
  }

  Serial.begin(9600);

  if (rtcWasAlreadyConfigured) {
    Serial.println(&quot;setup: RTC is already running&quot;);
  }
  else {
    Serial.println(&quot;setup: RTC was not running, so it was set to the time of compilation&quot;);
  }
}

void loop() {
  DateTime now = rtc.now();
  Serial.print(&quot;Year: &quot;);
  Serial.print(now.year());
  Serial.print(&quot; Month: &quot;);
  Serial.print(now.month());
  Serial.print(&quot; Day: &quot;);
  Serial.print(now.day());
  Serial.print(&quot; Hour: &quot;);
  Serial.print(now.hour());
  Serial.print(&quot; Minutes: &quot;);
  Serial.print(now.minute());
  Serial.print(&quot; Seconds: &quot;);
  Serial.print(now.second());
  Serial.println();

  delay(1000);
}
</code></pre>
<p>The first time you run this, you'll see the first line say:</p>
<blockquote>
<p>setup: RTC was not running, so it was set to the time of compilation</p>
</blockquote>
<p>.. and then you'll see the date and time shown every second.</p>
<p>If you remove the USB cable and then re-insert it then you'll see the message:</p>
<blockquote>
<p>setup: RTC is already running</p>
</blockquote>
<p>.. and then the date and time will continue to show every second <em>and it will be the correct date and time</em> (it won't have reset each time that the USB cable is connected and the &quot;setup&quot; function is run again).</p>
<p><strong>Gotcha Four:</strong> When disconnecting and reconnecting the USB lead, sometimes (if not always) I need to close the Serial Monitor and then re-open it otherwise it won't update and it will say that the COM port is busy if I try to upload a sketch to the board.</p>
<p><strong>Gotcha Five:</strong> I've seen a lot of examples use &quot;RTC_Millis&quot; instead of &quot;RTC_DS1307&quot; in timing code samples. This is <em>not</em> what we want! That is a timer that is simulated by the board and it just uses the &quot;millis()&quot; function to track time which, as I explained earlier, is no good for persisting time across resets. We want to use &quot;RTC_DS1307&quot; because that uses the RTC on the shield, which <em>will</em> maintain the time between power cycles due to the battery on the board.</p>
<p><strong>Gotcha Six:</strong> If you don't include &quot;Wire.h&quot; and call &quot;Wire.begin();&quot; at the start of setup then the RTC won't work properly and you will always get the same weird date displayed when you read it:</p>
<blockquote>
<p>Year: 2165 Month: 165 Day: 165 Hour: 165 Minutes: 165 Seconds: 85</p>
</blockquote>
<h3>Step 3: An external power source</h3>
<p>So far, the board has only been powered up when connected to the USB lead but this is not the only option. There are a few approaches that you can take; a regulated 5V input, the barrel-shaped power jack and the option of applying power to the vin and gnd pins on the board.</p>
<p>The power jack makes most sense when you are connecting to some sort of wall wart but I want a &quot;disconnected&quot; power supply for outside. I did a bunch of reading on this and some people are just connecting a simple 9V battery to the vin/gnd pins but apparently that's not very efficient - the amount of power stored in a standard MN1604 9V battery (the common kind that you might use in a smoke alarm) is comparatively low and the vin/gnd pins will be happy with something in the 6V-12V range and there is said to be more loss in regulating 9V to the internal 5V than there would be from a 6V supply.</p>
<p>So I settled on a rechargable 6V sealed lead acid battery, which I believe is often used in big torches or in remote control cars. I got one for £8 delivered from ebay that is stated to have 4.5Ah (which is a measure, essentially, of how much energy it stores) - for reference, a 9V battery will commonly have about 0.5Ah and so will run out much more quickly. Whatever battery you select, there are ways to eke out more life from them, which I'll cover shortly.</p>
<p>It's completely safe to connect the battery to the vin/gnd ports at the same time as the USB lead is inserted, so you don't have to worry about only providing power by the battery <em>or</em> the USB lead and you can safely connect and disconnect the USB lead while the battery is connected as often as you like.</p>
<h3>Step 4: Capturing light levels</h3>
<p>The starter kit that I've got conveniently included an LDR (a &quot;Light Dependent Resistor&quot; aka a &quot;photo-resistor&quot;) and so I just had to work out how to connect that. I knew that the Arduino has a range of digital input/output pins and that it has some analog input pins but I had to remind myself of some basic electronics to put it all together.</p>
<p>What you <em>can't</em> do is just put 5V into one pin of the LDR and connect the other end of the LDR straight into an analog pin. I'm going to try to make a stab at a simple explanation here and then refer you to someone who can explain it better!</p>
<p>The analog pin will read a voltage value from between 0 and 5V and allow this to be read in code as a numeric value between 0 and 1023 (inclusive). When we talk about the 5V output pin, this only makes sense in the context of the ground of the board - so the concept of a 5V output with no gnd pin connection makes no sense, there is nothing for that 5V to be measured relative to. So what we need to do is use the varying resistance of the LDR and somehow translate that into a varying voltage to provide to an analog pin (I chose A0 in my build).</p>
<p>The way to do this is with a &quot;voltage divider&quot;, which is essentially a circuit that looks a bit like this:</p>
<pre><code>gnd &lt;--&gt; resistor &lt;--&gt; connection-to-analog-input &lt;--&gt; LDR &lt;--&gt; 5V
</code></pre>
<p>If the resistance of the LDR happens to precisely match that resistance of the fixed resistor then precisely 2.5V will be delivered to the analog input. But if the LDR resistance is higher or lower than the fixed resistor's value then a higher or lower voltage will be delivered to analog pin.</p>
<p>There is a <a href="https://learn.adafruit.com/photocells/using-a-photocell">tutorial on learn.adafruit.com</a> that does a much better job of explaining it! It also suggests what fixed resistor values that you might use for different environments (eg. are you more interested in granular light level readings at low light levels but don't mind saturation at high levels or are you more interested in more granular readings at high levels and less granular at lower?) - at the moment, I'm still experimenting with a few different fixed resistor values to see which ones work for my particular climate.</p>
<p>The shield that I'm using solder pads for mounting components onto but I wasn't brave enough for that, so I've been using the pass-through pins and connecting them to the bread board that came with my starter kit.</p>
<p>When it's not connected to a power supply, it looks a bit like this:</p>
<img alt="The Arduino-plus-shield connected to an LDR on a breadboard" src="/Content/Images/Posts/ArduinoWithBreadboardAlongside.jpg" class="NoBorder AlwaysFullWidth" />
<p>The code to read the light level value looks like this (while running this code, try slowly moving your hand closer and further from covering the sensor to see the value change when it's read each second) -</p>
<pre><code>void setup() {
  Serial.begin(9600);
}

void loop() {
  Serial.print(&quot;Light level reading: &quot;);
  Serial.print(analogRead(0));
  Serial.println();

  delay(1000);
}
</code></pre>
<p>In an effort to start putting all of this together into a more robust package, I picked up a pack of self-adhesive felt pads from the supermarket and stuck them to appropriate points under the breadboard -</p>
<img alt="Felt pads to more easily align the breadboard on top of the Arduino and shield" src="/Content/Images/Posts/ArduinoBreadboardFeltPads.jpg" class="NoBorder AlwaysFullWidth" />
<img alt="Felt pads attached to the underside of the breadboard" src="/Content/Images/Posts/ArduinoBreadboardWithFeltPadsAttached.jpg" class="NoBorder AlwaysFullWidth" />
<p>.. and then I secured it all together with an elastic band:</p>
<img alt="Arduino plus shield plus breadboard secured in a tower" src="/Content/Images/Posts/ArduinoTower.jpg" class="NoBorder AlwaysFullWidth" />
<h3>Step 5: Sleeping when not busy</h3>
<p>In my ideal dream world, I would be able to leave my light level monitoring box outside for a few months. As I explained earlier, due to the direction that my garden faces, the hours at which the sun hits it fully varies by several hours depending upon the time of year. However, NO battery is going to last forever and even with this 4.5Ah battery that is at a 6V output (which is only a small jump down to regulate to 5V), the time that it can keep things running is limited.</p>
<p><em>Note: Recharging via a solar panel sounds interesting but it's definitely a future iteration possibility at this point!</em></p>
<p>There are, however, some things that can be done to eke out the duration of the battery by reducing the power usage of the board. There are ways to put the board into a &quot;power down&quot; state where it will do less - its timers will stop and its CPU can have a rest. There are tutorials out there about how to put it into this mode and have it only wake up on an &quot;interrupt&quot;, which can be an external circuit setting an input pin (maybe somehow using the RTC on the shield I'm using) <em>or</em> using something called the &quot;<a href="https://create.arduino.cc/projecthub/rafitc/what-is-watchdog-timer-fffe20">Watchdog Timer</a>&quot; that stays running on the Arduino even when it's in power down mode.</p>
<p>I read <em>a lot</em> of posts and tutorials on this and I really struggled to get it to work. Until, finally, I came across this one: <a href="https://circuitdigest.com/microcontroller-projects/arduino-sleep-modes-and-how-to-use-them-to-reduce-power-consumption">Arduino Sleep Modes and How to use them to Save the Power</a>. It explains in a clear table the difference between the different power-reduced modes (idle, power-save, power-down, etc..) <em>and</em> it recommends a library called &quot;<a href="https://github.com/rocketscream/Low-Power">Low-Power</a>&quot; that takes all of the hard work out of it.</p>
<p>Whereas other tutorials talked about calling &quot;sleep_enable()&quot; and &quot;set_sleep_mode(..)&quot; functions and then using &quot;attachInterrupt(..)&quot; and adding some magic method to then undo all of those things, this library allows you to write a one-liner as follows:</p>
<pre><code>LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF);
</code></pre>
<p>This willl cause the board to go into its most power-saving mode for eight seconds (which is the longest that's possible when relying upon its internal Watchdog Timer to wake it up).</p>
<p>No muss, no fuss.</p>
<p>I haven't measured yet how long that my complete device can sit outside in its waterproof box on a single charge of a battery but I'm confident that it's definitely measured in days, not hours - and that was <em>before</em> introducing this &quot;LowPower.powerDown(..)&quot; call.</p>
<p>Since I only want a reading every 30-60s, I call &quot;LowPower.powerDown(..)&quot; in a loop so that there are several 8s power down delays. While I haven't confirmed this yet, I would be astonished if it didn't last <em>at least</em> a week out there on one charge. And if I have to bring it in some nights (when it's dark and I don't care about light measurements) to charge it, then that's fine by me (though I'd like to be as infrequently as possible).</p>
<p><strong>Gotcha Seven:</strong> When entering power-down mode, if you are connected to the USB port in order to use the Serial Monitor to watch what's going on, ensure that you call &quot;Serial.flush()&quot; before entering power-down, otherwise the message might get buffered up and not fully sent through the serial connection before the board takes a nap.</p>
<h3>Step 6: Preparing for the outdoors (in the British weather!)</h3>
<p>I always associate the brand &quot;<a href="https://www.independent.co.uk/life-style/food-and-drink/how-tupperware-s-fate-was-sealed-a7899771.html">Tupperware</a>&quot; as being a very British thing - it's what we get packed lunches put into and what we get takeaway curries in. At least, I <em>think</em> that it is - maybe it's like &quot;hoover&quot;, where everyone uses the phrase &quot;hoover&quot; when they mean their generic vacuum cleaner. Regardless the origin, this seemed like the simplest way to make my device waterproof. The containers are not completely transparent but they shouldn't make a significant impact on the light levels being recorded by the photo-resistor because they're also far from opaque. And these containers are sealable, waterproof and come in all shapes and sizes!</p>
<p>I took my elastic-band-wrapped &quot;stack&quot; of Arduino-plus-shield-plus-breadboard and connected it to the battery -</p>
<img alt="The Arduino 'stack' connected to a battery" src="/Content/Images/Posts/ArduinoStackWithBattery.jpg" class="NoBorder AlwaysFullWidth" />
<p>.. and put in a plastic box. By turning the battery so that it was length-side-up, it was quite a snug fit and meant that the battery wouldn't slide around inside the box. There wasn't a lot of space for the stack to move around and so it seemed like quite a secure arrangement:</p>
<img alt="The Arduino 'stack' and battery in its waterproof container" src="/Content/Images/Posts/ArduinoInBox.jpg" class="NoBorder AlwaysFullWidth" />
<h3>Step 7: The final code</h3>
<p>So far, each code sample has demonstrated <em>aspects</em> of what I want to do but now it's time to bring it all fully together.</p>
<p>In trying to write the following code, I was reminded how much I've taken for granted in C# (and other higher level languages) with their string handling! I tried a little C and C++ <em>maaaaany</em> years ago and so writing Arduino code was a bit of a throwback for me - at first, I was trying to make a char array for a filename and I set the length of the array to be the number of characters that were required for the filename.. silly me, I had forgotten that C strings need to be null-terminated and so you need an extra zero character at the end in order for things to work properly! Failing to do so would not result in a compile or run time error, it would just mean that the files weren't written properly. Oh, how I've been spoilt! But, on the other hand, it also feels kinda good being this close to the &quot;bare metal&quot; :)</p>
<p>The following sketch will record the light level about twice a minute to a file on the SD card where the filename is based upon the current date (as maintained by the RTC module and its CR1220 battery) -</p>
<pre><code>#include &lt;Wire.h&gt;
#include &lt;SdFat.h&gt;    // https://github.com/greiman/SdFat
#include &lt;RTClib.h&gt;   // https://github.com/adafruit/RTClib
#include &lt;LowPower.h&gt; // https://github.com/rocketscream/Low-Power

// chipSelect = 10 according to &quot;Item description&quot; section of
// https://www.play-zone.ch/de/dk-data-logging-shield-v1-0.html
#define SD_CHIP_SELECT 10

RTC_DS1307 rtc;

void setup() {
  // The clock won't work with this (thanks https://arduino.stackexchange.com/a/44305!)
  Wire.begin();

  bool rtcWasAlreadyConfigured;
  if (rtc.isrunning()) {
    rtcWasAlreadyConfigured = true;
  }
  else {
    rtc.adjust(DateTime(__DATE__, __TIME__));
    rtcWasAlreadyConfigured = false;
  }

  Serial.begin(9600);

  if (rtcWasAlreadyConfigured) {
    Serial.println(&quot;setup: RTC is already running&quot;);
  }
  else {
    Serial.println(&quot;setup: RTC was not running, so it was set to the time of compilation&quot;);
  }
}

void loop() {
  // Character arrays need to be long enough to store the number of &quot;real&quot; characters plus the
  // null terminator
  char filename[13]; // yyyyMMdd.txt = 12 chars + 1 null
  char timestamp[9]; // 00:00:00     =  8 chars + 1 null
  DateTime now = rtc.now();
  snprintf(filename, sizeof(filename), &quot;%04u%02u%02u.txt&quot;, now.year(), now.month(), now.day());
  snprintf(timestamp, sizeof(timestamp), &quot;%02u:%02u:%02u&quot;, now.hour(), now.minute(), now.second());

  int sensorValue = analogRead(0);

  Serial.print(filename);
  Serial.print(&quot; &quot;);
  Serial.print(timestamp);
  Serial.print(&quot; &quot;);
  Serial.println(sensorValue);

  SdFat sd;
  if (!sd.begin(SD_CHIP_SELECT, SPI_HALF_SPEED)) {
    Serial.println(&quot;ERROR: sd.begin() failed&quot;);
  }
  else {
    SdFile file;
    if (!file.open(filename, O_WRITE | O_APPEND | O_CREAT)) {
      Serial.println(&quot;ERROR: file.open() failed - unable to write&quot;);
    }
    else {
      file.print(timestamp);
      file.print(&quot; Sensor value: &quot;);
      file.println(sensorValue);
      file.close();
    }
  }

  Serial.flush(); // Ensure we finish sending serial messages before going to sleep

  // 4x 8s is close enough to a reading every 30s, which gives me plenty of data
  // - Using this instead of &quot;delay&quot; should mean that the battery will power the device for longer
  for (int i = 0; i &lt; 3; i++) {
    LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF);
  }
}
</code></pre>
<p>At the moment, I'm bringing the box inside each night and then disconnecting the battery, pulling out the card and looking at the values recorded in the file to see if it's clear when the sun was fully hitting the table that I had placed the box on.</p>
<p>I've only started doing this in the last couple of days and each day has been rather grey and so there haven't been any sunny periods so that I can confirm that the readings clearly distinguish between &quot;regular daylight&quot; and &quot;sun directly on the table&quot;. Once I get some sun again, I'll be able to get a better idea - and if I <em>can't</em> distinguish well enough then I'll adjust the pull-down resistor that splits the voltage with the LDR and keep experimenting!</p>
<p>When I'm happy with the configuration, <em>then</em> I'll start experimenting with leaving the box outside for longer to see how long this battery can last in conjunction with the &quot;LowPower.powerDown(..)&quot; calls. One obvious optimisation for my use case would be to continue keeping it in power-down mode between the hours of 10pm and 8am - partly because I know that it will definitely be dark after 10pm and partly because I am <em>not</em> a morning person and so would not want to be outside before 8am, even if it <em>was</em> streaming with light (which it wouldn't be due to when my yard actually gets direct sunlight).</p>
<p><strong>Gotcha Eight:</strong> The RTC has no awareness of daylight savings time and so I'll need to take this into account when the clocks change in the UK. I'll worry about this another day!</p>
<h3>Step 8: Draw some graphs (one day)</h3>
<p>As you can tell from the above, I'm still very much in the early phases of gathering data. But, at some point, I'm going to have to <em>use</em> this data to predict when the yard will get sun for future dates - once I've got a few months of data for different times of year, hopefully I'll be able to do so!</p>
<p>I foresee a little bit of data-reading and Excel-graph-drawing in my future! There's just something about seeing <a href="/when-a-disk-cache-performs-better-than-an-inmemory-cache-befriending-the-net-gc">results on a graph</a> that make everything feel so much more real. As much as I'd like to be able to stare at 1000s of numbers and read them like the Matrix, seeing trends and curves plotted out just feels so much more satisfying and definitive. Maybe there will be a follow-up post with the results, though I feel that they would be much more personal and less useful to the general populace than even <em>my</em> standard level of esoteric and niche blog posts! Maybe there are some graphs in my Twitter stream's future!</p>
<p>On the other hand.. if I learn any more power-saving techniques or have any follow-up information about how long these rechargeable torch-or-remote-control batteries last then maybe <em>that</em> will be grounds for a follow-up!</p>
<p>In the meantime, I hope you've enjoyed this little journey - and if you've tried to do anything similar with these cheap Deek Robot boards, then maybe the code samples here have been of use to you. I hope so! (Because, goodness knows, feeling like a beginner again and getting onto those new forums has been <em>quite</em> an experience!)</p>
<p class="PostTime">Posted at 21:34</p><div class="PreviousAndNext"><div class="Previous"><h3>Last time:</h3><a class="Previous" href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp">How are barcodes read?? (Library-less image processing in C#)</a></div><div class="Next"><h3>Next:</h3><a class="Next" href="/language-detection-and-wordsinsentence-classification-in-c-sharp">Language detection and words-in-sentence classification in C#</a></div></div><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts-part-2">Automating &quot;suggested / related posts&quot; links for my blog posts - Part 2</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts">Automating &quot;suggested / related posts&quot; links for my blog posts</a></li><li><a href="/javascript-compression-putting-my-json-search-indexes-on-a-diet">JavaScript Compression (Putting my JSON Search Indexes on a diet)</a></li></ul></div>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
					var disqus_identifier = "118";
					var disqus_title = "Monitoring my garden\u0027s limited sunlight time period with an Arduino (and some tupperware)";
					(function () {
						whenjQueryIsAvailable(
							function () {
								$(function () {
									loadCommentsIfHalfwayDownAndNotAlreadyLoaded();
									$(window).scroll(loadCommentsIfHalfwayDownAndNotAlreadyLoaded);
								});
							}
						);

						var bStartedLoadingComments = false;
						function loadCommentsIfHalfwayDownAndNotAlreadyLoaded() {
							if (bStartedLoadingComments) {
								return;
							}
							var $post = $("div.Content.SinglePost");
							var bottomOfPost = $post.position().top + $post.height();
							var $window = $(window);
							if (($window.scrollTop() + $window.height()) >= (bottomOfPost / 2)) {
								bStartedLoadingComments = true;
								loadComments();
							}
						}

						function loadComments() {
							var dsq = document.createElement("script");
							dsq.type = "text/javascript";
							dsq.async = true;
							dsq.src = "https://" + disqus_shortname + ".disqus.com/embed.js";
							(document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
						}
					}());
                </script>
    </div>


				<div class="Footer">
					© Productive Rage 2011 - 2022
				</div>
			</div>

			<div class="SideBar">
				<div class="About">
					<h2>About</h2>
					<p>Dan is a big geek who likes making stuff with computers! He can be quite outspoken so clearly needs a blog :)</p>
					<p>In the last few minutes he seems to have taken to referring to himself in the third person. He's quite enjoying it.</p>
					<p><a href="mailto:dangger36@gmail.com" class="Email">dangger36@gmail.com</a></p>
				</div>
				<div class="Search">
<form action="/Search" method="get">						<div>
							<input type="text" class="SiteSearch" name="term" value="" />
							<input type="submit" class="SiteSearchSubmit" value="Search" />
						</div>
</form>				</div>
				<div class="Recent"><h2>Recent Posts</h2><ul><li><a href="/parallelising-linq-work-in-c-sharp">Parallelising (LINQ) work in C#</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts-part-2">Automating &quot;suggested / related posts&quot; links for my blog posts - Part 2</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts">Automating &quot;suggested / related posts&quot; links for my blog posts</a></li><li><a href="/language-detection-and-wordsinsentence-classification-in-c-sharp">Language detection and words-in-sentence classification in C#</a></li><li><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware">Monitoring my garden&#x27;s limited sunlight time period with an Arduino (and some tupperware)</a></li></ul><div class="RSSFeedLink"><a href="https://www.productiverage.com/feed">RSS Feed</a></div></div>
				<div class="Featured"><h2>Highlights</h2><ul><li><a href="/face-or-no-face-finding-faces-in-photos-using-c-sharp-and-accordnet">Face or no face (finding faces in photos using C# and Accord.NET)</a></li><li><a href="/when-a-disk-cache-performs-better-than-an-inmemory-cache-befriending-the-net-gc">When a disk cache performs better than an in-memory cache (befriending the .NET GC)</a></li><li><a href="/performance-tuning-a-bridgenet-react-app">Performance tuning a Bridge.NET / React app</a></li><li><a href="/creating-a-c-sharp-roslyn-analyser-for-beginners-by-a-beginner">Creating a C# (&quot;Roslyn&quot;) Analyser - For beginners by a beginner</a></li><li><a href="/translating-vbscript-into-c-sharp">Translating VBScript into C#</a></li><li><a href="/entity-framework-projections-to-immutable-types-ienumerable-vs-iqueryable">Entity Framework projections to Immutable Types (IEnumerable vs IQueryable)</a></li></ul></div>
				<div class="History"><h2>Archives</h2><ul><li><a href="/Archive/8/2021">August 2021 (1)</a></li><li><a href="/Archive/4/2021">April 2021 (2)</a></li><li><a href="/Archive/3/2021">March 2021 (1)</a></li><li><a href="/Archive/8/2020">August 2020 (3)</a></li><li><a href="/Archive/7/2019">July 2019 (2)</a></li><li><a href="/Archive/9/2018">September 2018 (1)</a></li><li><a href="/Archive/4/2018">April 2018 (1)</a></li><li><a href="/Archive/3/2018">March 2018 (1)</a></li><li><a href="/Archive/7/2017">July 2017 (1)</a></li><li><a href="/Archive/6/2017">June 2017 (1)</a></li><li><a href="/Archive/2/2017">February 2017 (1)</a></li><li><a href="/Archive/11/2016">November 2016 (1)</a></li><li><a href="/Archive/9/2016">September 2016 (2)</a></li><li><a href="/Archive/8/2016">August 2016 (1)</a></li><li><a href="/Archive/7/2016">July 2016 (1)</a></li><li><a href="/Archive/6/2016">June 2016 (1)</a></li><li><a href="/Archive/5/2016">May 2016 (3)</a></li><li><a href="/Archive/3/2016">March 2016 (3)</a></li><li><a href="/Archive/2/2016">February 2016 (2)</a></li><li><a href="/Archive/12/2015">December 2015 (1)</a></li><li><a href="/Archive/11/2015">November 2015 (2)</a></li><li><a href="/Archive/8/2015">August 2015 (3)</a></li><li><a href="/Archive/7/2015">July 2015 (1)</a></li><li><a href="/Archive/6/2015">June 2015 (1)</a></li><li><a href="/Archive/5/2015">May 2015 (2)</a></li><li><a href="/Archive/4/2015">April 2015 (1)</a></li><li><a href="/Archive/3/2015">March 2015 (1)</a></li><li><a href="/Archive/1/2015">January 2015 (2)</a></li><li><a href="/Archive/12/2014">December 2014 (1)</a></li><li><a href="/Archive/11/2014">November 2014 (1)</a></li><li><a href="/Archive/10/2014">October 2014 (2)</a></li><li><a href="/Archive/9/2014">September 2014 (2)</a></li><li><a href="/Archive/8/2014">August 2014 (1)</a></li><li><a href="/Archive/7/2014">July 2014 (1)</a></li><li><a href="/Archive/6/2014">June 2014 (1)</a></li><li><a href="/Archive/5/2014">May 2014 (2)</a></li><li><a href="/Archive/2/2014">February 2014 (1)</a></li><li><a href="/Archive/1/2014">January 2014 (1)</a></li><li><a href="/Archive/12/2013">December 2013 (1)</a></li><li><a href="/Archive/11/2013">November 2013 (1)</a></li><li><a href="/Archive/10/2013">October 2013 (1)</a></li><li><a href="/Archive/8/2013">August 2013 (3)</a></li><li><a href="/Archive/7/2013">July 2013 (3)</a></li><li><a href="/Archive/6/2013">June 2013 (1)</a></li><li><a href="/Archive/5/2013">May 2013 (2)</a></li><li><a href="/Archive/4/2013">April 2013 (1)</a></li><li><a href="/Archive/3/2013">March 2013 (8)</a></li><li><a href="/Archive/2/2013">February 2013 (2)</a></li><li><a href="/Archive/1/2013">January 2013 (2)</a></li><li><a href="/Archive/12/2012">December 2012 (3)</a></li><li><a href="/Archive/11/2012">November 2012 (4)</a></li><li><a href="/Archive/9/2012">September 2012 (1)</a></li><li><a href="/Archive/8/2012">August 2012 (1)</a></li><li><a href="/Archive/7/2012">July 2012 (3)</a></li><li><a href="/Archive/6/2012">June 2012 (3)</a></li><li><a href="/Archive/5/2012">May 2012 (2)</a></li><li><a href="/Archive/2/2012">February 2012 (3)</a></li><li><a href="/Archive/1/2012">January 2012 (4)</a></li><li><a href="/Archive/12/2011">December 2011 (7)</a></li><li><a href="/Archive/8/2011">August 2011 (2)</a></li><li><a href="/Archive/7/2011">July 2011 (1)</a></li><li><a href="/Archive/5/2011">May 2011 (1)</a></li><li><a href="/Archive/4/2011">April 2011 (2)</a></li><li><a href="/Archive/3/2011">March 2011 (3)</a></li></ul><div class="EveryTitle"><a href="/Archive/All">Every Post Title</a></div></div>
			</div>

		</div>
	</div>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="/Scripts/jquery.autocomplete.min.js"></script>
	<script type="text/javascript" src="/Scripts/prettify.js"></script>
	<script type="text/javascript" src="/Scripts/Site.js"></script>
	<script type="text/javascript" src="/Scripts/IndexSearchGenerator.js"></script>
	<script type="text/javascript" src="/Scripts/SearchTermHighlighter.js"></script>
	<script type="text/javascript" src="/Scripts/SearchPage.js"></script>
	<script type="text/javascript" src="/Scripts/LZString.js"></script>

</body>
</html>
