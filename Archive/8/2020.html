<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title>Productive Rage - August 2020</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#393939" />
	<link rel="stylesheet" type="text/css" media="all" href="/Content/Styles.css" />
	<link rel="stylesheet" type="text/css" media="print" href="/Content/PrintOverrides.css" />
	<meta name="robots" content="noindex, follow" />
	<link rel="shortcut icon" href="/favicon.ico" />
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.productiverage.com/feed" />
	<script type="text/javascript">
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', "UA-32312857-1", { 'storage': 'none' });
		ga('send', 'pageview');
	</script>
    <meta name="description" content="Archive for August 2020" />
</head>

<body>

	<div class="Header">
		<div class="HeaderContent">
			<h1>
				<a href="/">Productive Rage</a>
			</h1>
			<span class="Tagline">Dan's techie ramblings</span>
		</div>
	</div>

	<div class="WrapperOuter">
		<div class="Wrapper">
			<div class="Main HasSideBar">
				

        <script type="text/javascript">
            var disqus_shortname = "productiverage";
            document.addEventListener(
                "DOMContentLoaded",
                function () {
                    var commentsLinks = document.querySelectorAll("div.Content p.Comments");
                    for (var i = 0; i < commentsLinks.length; i++) {
                        commentsLinks[i].style.display = "block";
                    }
                }
            );
        </script>

    <div class="Content ArchiveByMonth">
        <p class="PostDate">22 August 2020</p><h2 id="monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware">Monitoring my garden's limited sunlight time period with an Arduino (and some tupperware)</a></h2>
<p>My house has a lovely little garden out front. The house and garden itself are elevated one storey above the street (and so my basement is really more of a bizarre ground floor because it has natural light windows but is full of dust and my life-accumulated rubbish is in one room of it while my covid-times &quot;trying to stay fit, not fat&quot; home gym is in the other) and there was no fence around it when I moved in. Meaning that that the <em>interesting characters</em> that amble past (suffice to say that I went for a nicer house in a slightly on-the-cusp between classy and rougher neighbourhoods as opposed to a less nice house in a posh place) could see in and converse between sips on their 9am double-strength lager. Once fenced off, kitted out with a cute little table and chairs that my friendly neighbours found at a tip and with some lovely raised flower beds installed, it is a <em>delight</em> in Summer.. only problem is that my house faces the wrong way and so only gets direct sunlight at certain hours of the day. And this time period varies greatly depending upon the time of year - in March, it might not get the light until almost 5pm whilst in July and August it's getting warm and light and beautiful (well, on the days that English weather allows) more in time for a late lunch.</p>
<p>The problem is that, even after four years here, I still don't really have any idea when it's going to be sunny there for a given time of year and I want to be able to plan opportunities around it - late evening drinks outside with friends, lunch time warm weather meals for myself, just any general chance top up my vitamin D!</p>
<img alt="Rare English sun in my garden (plus cats)" src="/Content/Images/Posts/SunnyGardenAndCats.jpg" class="NoBorder AlwaysFullWidth" title="Rare English sun in my garden (plus cats)" />
<p>I guess that one way to sort this out would be to just keep an eye out on sunny days and take the opportunity whenever it strikes. A more organised plan would be to start a little diary and mark down every fortnight or so through the year when the sun hits the garden and when it leaves.</p>
<p>But I work in technology, damnnit, and so I expect to be able to solve this using that electronics and magic! (Cue comments about everything looking like a nail when you're holding a hammer).</p>
<p>To be <em>really</em> honest, maybe I'm describing this situation back to front. My friend gave me an <a href="https://store.arduino.cc/arduino-uno-rev3">Arduino UNO r3</a> because he had a kit spare from the coding club that he runs for kids locally and I'd been looking for a use for it.. and this seemed like it!</p>
<h3 id="what-i-needed"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#what-i-needed">What I needed</a></h3>
<p>Being a total Arduino noob (and, since my Electronics GCSE was over 20 years ago now, I'm basically a total hardware noob.. you should have seen the trouble that I had trying to build a custom PC a few years ago; I swear it was easier when I was 14!) I wanted something nice and simple to begin with.</p>
<p>So I had the starter kit, which included the Arduino board and some jumper cables, a prototyping breadboard and some common components (including, essentially, a photoresistor) and so I figured that all I'd then need is a way to record the light levels periodically, a power source and some sort of container for when it rains (again; England).</p>
<p>I considered having some sort of fancy wifi server in it that would record the values somehow and let me either poll it from somewhere else or have it push those results to the cloud somewhere but eventually decided to go for what seemed like a simpler, more robust and (presumably) more power efficient mechanism of storing the light values throughout the day - using an SD card. Because I'd got the kit for free (on the agreement that I would try to do something useful with it), I was looking for something cheap to write to an SD card that I'd had lying around since.. well, I guess since whenever SD cards were useful. Could it have been a digital camera? The very concept seems absurd these days, with the quality of camera that even phones from three or four generations ago have.</p>
<p>I came across something called a &quot;<strong>Deek Robot SD/RTC datalogging shield</strong>&quot; that would not only write to an SD card but would also keep time due to a small battery mounted on it.</p>
<p>These are cheap (mine was less than £5 delivered, new from eBay) but documentation is somewhat.. spotty. There is a lot of documentation for the &quot;Adafruit Assembled Data Logging shield&quot; but they cost more like £13+ and I was looking for the cheap option. Considering how much time I spent trying to make it work and find good information, it probably would have made more sense to buy a better supported shield than a knock-off from somewhere.. but I <em>did</em> get it working eventually, so I'll share all the code throughout this post!</p>
<img alt="The Arduino UNO r3 with a Deek Robot SD/RTC shield installed" src="/Content/Images/Posts/ArduinoAndShield.jpg" class="NoBorder AlwaysFullWidth" title="The Arduino UNO r3 with a Deek Robot SD/RTC shield installed" />
<p><em>Note: I found a warning that when using this particular shield, &quot;If you have a UNO with a USB type B connector this shield may NOT WORK because the male pins are NOT LONG ENOUGH&quot; on a <a href="https://forum.arduino.cc/index.php?topic=649395.0">forum page</a> - my UNO r3 does have the USB B connector but I've not had this problem.. though if you do encounter this problem then maybe some sort of pin extenders or raisers would fix it.</em></p>
<h3 id="step-1-writing-to-the-sd-card"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-1-writing-to-the-sd-card">Step 1: Writing to the SD card</a></h3>
<p>After reading around, I settled on a library called <a href="https://github.com/greiman/SdFat">SdFat</a> that should handle the disk access for me. I downloaded it from the Github repo and followed the &quot;Importing a .zip Library&quot; instructions on the <a href="https://www.arduino.cc/en/guide/libraries">Installing Additional Arduino Libraries</a> page.</p>
<p>This allowed me to stack the data logging shield on top of the UNO, put an SD card into the shield, connect the UNO to my PC via a USB lead and upload the following code -</p>
<pre><code>#include &lt;SdFat.h&gt; // https://github.com/greiman/SdFat

// chipSelect = 10 according to &quot;Item description&quot; section of
// https://www.play-zone.ch/de/dk-data-logging-shield-v1-0.html
#define SD_CHIP_SELECT 10

void setup() {
  Serial.begin(9600);

  // See &quot;Note 1&quot; further down about SPI_HALF_SPEED
  SdFat sd;
  if (!sd.begin(SD_CHIP_SELECT, SPI_HALF_SPEED)) {
    Serial.println(&quot;ERROR: sd.begin() failed&quot;);
  }
  else {
    SdFile file;
    if (!file.open(&quot;TestData.txt&quot;, O_WRITE | O_APPEND | O_CREAT)) {
      Serial.println(&quot;ERROR: file.open() failed - unable to write&quot;);
    }
    else {
      file.println(&quot;Hi!&quot;);
      file.close();
      Serial.println(&quot;Successfully wrote to file!&quot;);
    }
  }
}

void loop() { }
</code></pre>
<p>The Arduino IDE has an option to view the serial output (the messages written to &quot;Serial.println&quot;) by going to Tools / Serial Monitor. Ensure that the baud rate shown near the bottom right of the window is set to 9600 to match the setting in the code above.</p>
<p>This happily showed</p>
<blockquote>
<p>Successfully wrote to file!</p>
</blockquote>
<p>in the Serial Monitor's output and when I yanked the card out and put it into my laptop to see if it had worked, it did indeed have a file on it called &quot;TestData.txt&quot; with a single line saying &quot;Hi!&quot; - an excellent start!</p>
<p><em>Note 1: In the &quot;sd.begin&quot; call, I specify <strong>SPI_HALF_SPEED</strong> primarily because that's what most of the examples that I've found use - there is an option <strong>SPI_FULL_SPEED</strong> but I read in <a href="https://community.particle.io/t/has-anyone-had-success-hooking-up-an-sd-card-to-the-photon-and-writing-reading-data/24026/41">an Arduino forum thread</a> that: &quot;You should be able to use <strong>SPI_FULL_SPEED</strong> instead, but if that produces communication errors you can use SD_SCK_HZ(4 * MHZ) instead of <strong>SPI_HALF_SPEED</strong>&quot; and I'm not sure what might be the limiting factor with said communication errors; whether it's the card or the shield or something else and I'm only going to be writing small amounts of data at relatively infrequent intervals and so I thought that I would err on the safe side and stick with <strong>SPI_HALF_SPEED</strong>.</em></p>
<p><em>Note 2: In a lot of code samples, in the &quot;setup&quot; method you will see code after the &quot;Serial.begin(..)&quot; call that looks like this:</em></p>
<pre><code>while (!Serial) {
  // wait for serial port to connect - needed for native USB
}
</code></pre>
<p><em>^ This is only needed for particular variants of the Arduino - the &quot;Leonardo&quot;, I believe - and is not required for the UNO and so I haven't included it in my code.</em></p>
<p><strong>Gotcha One:</strong> Initially, I had formatted my SD card (branded as &quot;Elgetec&quot;, who I can't remember ever hearing of other than on this card) on my Windows laptop - doing a full format, to make absolutely sure that it was as ready for action as possible. However, not only did that full format take a long time, I found that when I left my Arduino shield writing files over a period of a few hours then it would often get reported as being corrupted when I tried to read it. I've found that if the <a href="https://github.com/greiman/SdFat/blob/master/examples/SdFormatter/SdFormatter.ino">SdFormatter.ino</a> (from the examples folder of the SdFat GitHub repo) is used then these corruption problems have stopped occurring (and the formatting is much faster!).</p>
<p><strong>Gotcha Two:</strong> While I was fiddling around with writing to the SD card, particularly when connected to a battery instead of the USB port (where I could use the Serial Monitor to see what was happening), I tried setting the LED_BUILTIN to be on while writing and then go off again when the file was closed. This didn't work. And it <em>can't</em> work, though it took me a lot of reading to find out why. It turns out that the SPI (the <a href="https://www.arduino.cc/en/reference/SPI">Serial Peripheral Library</a>) connection from the Arduino to the Deek Robot shield will use IO pins 10, 11, 12 and 13 for its own communications. 13 happens to be the output used to set the LED_BUILTIN state and so you lose access to setting that built-in LED while this shield is connected. Specifically, &quot;<a href="https://forum.arduino.cc/index.php?topic=533606.msg3637549#msg3637549">pin 13 is the SPI clock. Pin 13 is also the built-in led and hence you have a conflict</a>&quot;.</p>
<h3 id="step-2-keeping-time"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-2-keeping-time">Step 2: Keeping time</a></h3>
<p>Since I want to record light levels throughout the day, it's important to know at what time the recording is being made. The shield that I'm using also includes an &quot;RTC&quot; (a real-time clock) and so I needed to work out how to set that once and then read from it each time I took a light level reading.</p>
<p>The UNO board itself can do some basic form of time keeping, such as telling you how long it's been since the board started / was last reset (via the <a href="https://www.arduino.cc/reference/en/language/functions/time/millis/">millis()</a> function) but there are a few limitations with this. You can bake into the compiled code the time at which it was compiled and you <em>could</em> then use that, in combination with &quot;millis()&quot;, to work out the current time but you will hit problems if power is temporarily lost or if the board is reset (because &quot;millis()&quot; will start from zero again and timing will start again from that baked-in &quot;compiled at&quot; time).</p>
<p><strong>Gotcha Three:</strong> I didn't realise when I was first fiddling with this that any time you connected the USB lead, it would reset the board and the program (the &quot;sketch&quot;, in Arduino-speak) would start all over again. (This will only make a difference if you're using an external power source because otherwise the program would <em>stop</em> whenever you disconnected the USB lead and there would be nothing running to reset when plugging the USB lead back in! I'll be talking about external power supplies further down).</p>
<p>So the next step was using the clock on the shield that I had bought, instead of relying on the clock on the Arduino board itself. To do this, I'd inserted a CR1220 battery and then tested with the following code:</p>
<pre><code>#include &lt;Wire.h&gt;
#include &lt;RTClib.h&gt; // https://github.com/adafruit/RTClib

RTC_DS1307 rtc;

void setup() {
  // The clock won't work with this (thanks https://arduino.stackexchange.com/a/44305!)
  Wire.begin();

  bool rtcWasAlreadyConfigured;
  if (rtc.isrunning()) {
    rtcWasAlreadyConfigured = true;
  }
  else {
    rtc.adjust(DateTime(__DATE__, __TIME__));
    rtcWasAlreadyConfigured = false;
  }

  Serial.begin(9600);

  if (rtcWasAlreadyConfigured) {
    Serial.println(&quot;setup: RTC is already running&quot;);
  }
  else {
    Serial.println(&quot;setup: RTC was not running, so it was set to the time of compilation&quot;);
  }
}

void loop() {
  DateTime now = rtc.now();
  Serial.print(&quot;Year: &quot;);
  Serial.print(now.year());
  Serial.print(&quot; Month: &quot;);
  Serial.print(now.month());
  Serial.print(&quot; Day: &quot;);
  Serial.print(now.day());
  Serial.print(&quot; Hour: &quot;);
  Serial.print(now.hour());
  Serial.print(&quot; Minutes: &quot;);
  Serial.print(now.minute());
  Serial.print(&quot; Seconds: &quot;);
  Serial.print(now.second());
  Serial.println();

  delay(1000);
}
</code></pre>
<p>The first time you run this, you'll see the first line say:</p>
<blockquote>
<p>setup: RTC was not running, so it was set to the time of compilation</p>
</blockquote>
<p>.. and then you'll see the date and time shown every second.</p>
<p>If you remove the USB cable and then re-insert it then you'll see the message:</p>
<blockquote>
<p>setup: RTC is already running</p>
</blockquote>
<p>.. and then the date and time will continue to show every second <em>and it will be the correct date and time</em> (it won't have reset each time that the USB cable is connected and the &quot;setup&quot; function is run again).</p>
<p><strong>Gotcha Four:</strong> When disconnecting and reconnecting the USB lead, sometimes (if not always) I need to close the Serial Monitor and then re-open it otherwise it won't update and it will say that the COM port is busy if I try to upload a sketch to the board.</p>
<p><strong>Gotcha Five:</strong> I've seen a lot of examples use &quot;RTC_Millis&quot; instead of &quot;RTC_DS1307&quot; in timing code samples. This is <em>not</em> what we want! That is a timer that is simulated by the board and it just uses the &quot;millis()&quot; function to track time which, as I explained earlier, is no good for persisting time across resets. We want to use &quot;RTC_DS1307&quot; because that uses the RTC on the shield, which <em>will</em> maintain the time between power cycles due to the battery on the board.</p>
<p><strong>Gotcha Six:</strong> If you don't include &quot;Wire.h&quot; and call &quot;Wire.begin();&quot; at the start of setup then the RTC won't work properly and you will always get the same weird date displayed when you read it:</p>
<blockquote>
<p>Year: 2165 Month: 165 Day: 165 Hour: 165 Minutes: 165 Seconds: 85</p>
</blockquote>
<h3 id="step-3-an-external-power-source"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-3-an-external-power-source">Step 3: An external power source</a></h3>
<p>So far, the board has only been powered up when connected to the USB lead but this is not the only option. There are a few approaches that you can take; a regulated 5V input, the barrel-shaped power jack and the option of applying power to the vin and gnd pins on the board.</p>
<p>The power jack makes most sense when you are connecting to some sort of wall wart but I want a &quot;disconnected&quot; power supply for outside. I did a bunch of reading on this and some people are just connecting a simple 9V battery to the vin/gnd pins but apparently that's not very efficient - the amount of power stored in a standard MN1604 9V battery (the common kind that you might use in a smoke alarm) is comparatively low and the vin/gnd pins will be happy with something in the 6V-12V range and there is said to be more loss in regulating 9V to the internal 5V than there would be from a 6V supply.</p>
<p>So I settled on a rechargable 6V sealed lead acid battery, which I believe is often used in big torches or in remote control cars. I got one for £8 delivered from ebay that is stated to have 4.5Ah (which is a measure, essentially, of how much energy it stores) - for reference, a 9V battery will commonly have about 0.5Ah and so will run out much more quickly. Whatever battery you select, there are ways to eke out more life from them, which I'll cover shortly.</p>
<p>It's completely safe to connect the battery to the vin/gnd ports at the same time as the USB lead is inserted, so you don't have to worry about only providing power by the battery <em>or</em> the USB lead and you can safely connect and disconnect the USB lead while the battery is connected as often as you like.</p>
<h3 id="step-4-capturing-light-levels"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-4-capturing-light-levels">Step 4: Capturing light levels</a></h3>
<p>The starter kit that I've got conveniently included an LDR (a &quot;Light Dependent Resistor&quot; aka a &quot;photo-resistor&quot;) and so I just had to work out how to connect that. I knew that the Arduino has a range of digital input/output pins and that it has some analog input pins but I had to remind myself of some basic electronics to put it all together.</p>
<p>What you <em>can't</em> do is just put 5V into one pin of the LDR and connect the other end of the LDR straight into an analog pin. I'm going to try to make a stab at a simple explanation here and then refer you to someone who can explain it better!</p>
<p>The analog pin will read a voltage value from between 0 and 5V and allow this to be read in code as a numeric value between 0 and 1023 (inclusive). When we talk about the 5V output pin, this only makes sense in the context of the ground of the board - so the concept of a 5V output with no gnd pin connection makes no sense, there is nothing for that 5V to be measured relative to. So what we need to do is use the varying resistance of the LDR and somehow translate that into a varying voltage to provide to an analog pin (I chose A0 in my build).</p>
<p>The way to do this is with a &quot;voltage divider&quot;, which is essentially a circuit that looks a bit like this:</p>
<pre><code>gnd &lt;--&gt; resistor &lt;--&gt; connection-to-analog-input &lt;--&gt; LDR &lt;--&gt; 5V
</code></pre>
<p>If the resistance of the LDR happens to precisely match that resistance of the fixed resistor then precisely 2.5V will be delivered to the analog input. But if the LDR resistance is higher or lower than the fixed resistor's value then a higher or lower voltage will be delivered to analog pin.</p>
<p>There is a <a href="https://learn.adafruit.com/photocells/using-a-photocell">tutorial on learn.adafruit.com</a> that does a much better job of explaining it! It also suggests what fixed resistor values that you might use for different environments (eg. are you more interested in granular light level readings at low light levels but don't mind saturation at high levels or are you more interested in more granular readings at high levels and less granular at lower?) - at the moment, I'm still experimenting with a few different fixed resistor values to see which ones work for my particular climate.</p>
<p>The shield that I'm using solder pads for mounting components onto but I wasn't brave enough for that, so I've been using the pass-through pins and connecting them to the bread board that came with my starter kit.</p>
<p>When it's not connected to a power supply, it looks a bit like this:</p>
<img alt="The Arduino-plus-shield connected to an LDR on a breadboard" src="/Content/Images/Posts/ArduinoWithBreadboardAlongside.jpg" class="NoBorder AlwaysFullWidth" title="The Arduino-plus-shield connected to an LDR on a breadboard" />
<p>The code to read the light level value looks like this (while running this code, try slowly moving your hand closer and further from covering the sensor to see the value change when it's read each second) -</p>
<pre><code>void setup() {
  Serial.begin(9600);
}

void loop() {
  Serial.print(&quot;Light level reading: &quot;);
  Serial.print(analogRead(0));
  Serial.println();

  delay(1000);
}
</code></pre>
<p>In an effort to start putting all of this together into a more robust package, I picked up a pack of self-adhesive felt pads from the supermarket and stuck them to appropriate points under the breadboard -</p>
<img alt="Felt pads to more easily align the breadboard on top of the Arduino and shield" src="/Content/Images/Posts/ArduinoBreadboardFeltPads.jpg" class="NoBorder AlwaysFullWidth" title="Felt pads to more easily align the breadboard on top of the Arduino and shield" />
<img alt="Felt pads attached to the underside of the breadboard" src="/Content/Images/Posts/ArduinoBreadboardWithFeltPadsAttached.jpg" class="NoBorder AlwaysFullWidth" title="Felt pads attached to the underside of the breadboard" />
<p>.. and then I secured it all together with an elastic band:</p>
<img alt="Arduino plus shield plus breadboard secured in a tower" src="/Content/Images/Posts/ArduinoTower.jpg" class="NoBorder AlwaysFullWidth" title="Arduino plus shield plus breadboard secured in a tower" />
<h3 id="step-5-sleeping-when-not-busy"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-5-sleeping-when-not-busy">Step 5: Sleeping when not busy</a></h3>
<p>In my ideal dream world, I would be able to leave my light level monitoring box outside for a few months. As I explained earlier, due to the direction that my garden faces, the hours at which the sun hits it fully varies by several hours depending upon the time of year. However, NO battery is going to last forever and even with this 4.5Ah battery that is at a 6V output (which is only a small jump down to regulate to 5V), the time that it can keep things running is limited.</p>
<p><em>Note: Recharging via a solar panel sounds interesting but it's definitely a future iteration possibility at this point!</em></p>
<p>There are, however, some things that can be done to eke out the duration of the battery by reducing the power usage of the board. There are ways to put the board into a &quot;power down&quot; state where it will do less - its timers will stop and its CPU can have a rest. There are tutorials out there about how to put it into this mode and have it only wake up on an &quot;interrupt&quot;, which can be an external circuit setting an input pin (maybe somehow using the RTC on the shield I'm using) <em>or</em> using something called the &quot;<a href="https://create.arduino.cc/projecthub/rafitc/what-is-watchdog-timer-fffe20">Watchdog Timer</a>&quot; that stays running on the Arduino even when it's in power down mode.</p>
<p>I read <em>a lot</em> of posts and tutorials on this and I really struggled to get it to work. Until, finally, I came across this one: <a href="https://circuitdigest.com/microcontroller-projects/arduino-sleep-modes-and-how-to-use-them-to-reduce-power-consumption">Arduino Sleep Modes and How to use them to Save the Power</a>. It explains in a clear table the difference between the different power-reduced modes (idle, power-save, power-down, etc..) <em>and</em> it recommends a library called &quot;<a href="https://github.com/rocketscream/Low-Power">Low-Power</a>&quot; that takes all of the hard work out of it.</p>
<p>Whereas other tutorials talked about calling &quot;sleep_enable()&quot; and &quot;set_sleep_mode(..)&quot; functions and then using &quot;attachInterrupt(..)&quot; and adding some magic method to then undo all of those things, this library allows you to write a one-liner as follows:</p>
<pre><code>LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF);
</code></pre>
<p>This will cause the board to go into its most power-saving mode for eight seconds (which is the longest that's possible when relying upon its internal Watchdog Timer to wake it up).</p>
<p>No muss, no fuss.</p>
<p>I haven't measured yet how long that my complete device can sit outside in its waterproof box on a single charge of a battery but I'm confident that it's definitely measured in days, not hours - and that was <em>before</em> introducing this &quot;LowPower.powerDown(..)&quot; call.</p>
<p>Since I only want a reading every 30-60s, I call &quot;LowPower.powerDown(..)&quot; in a loop so that there are several 8s power down delays. While I haven't confirmed this yet, I would be astonished if it didn't last <em>at least</em> a week out there on one charge. And if I have to bring it in some nights (when it's dark and I don't care about light measurements) to charge it, then that's fine by me (though I'd like to be as infrequently as possible).</p>
<p><strong>Gotcha Seven:</strong> When entering power-down mode, if you are connected to the USB port in order to use the Serial Monitor to watch what's going on, ensure that you call &quot;Serial.flush()&quot; before entering power-down, otherwise the message might get buffered up and not fully sent through the serial connection before the board takes a nap.</p>
<h3 id="step-6-preparing-for-the-outdoors-in-the-british-weather"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-6-preparing-for-the-outdoors-in-the-british-weather">Step 6: Preparing for the outdoors (in the British weather!)</a></h3>
<p>I always associate the brand &quot;<a href="https://www.independent.co.uk/life-style/food-and-drink/how-tupperware-s-fate-was-sealed-a7899771.html">Tupperware</a>&quot; as being a very British thing - it's what we get packed lunches put into and what we get takeaway curries in. At least, I <em>think</em> that it is - maybe it's like &quot;hoover&quot;, where everyone uses the phrase &quot;hoover&quot; when they mean their generic vacuum cleaner. Regardless the origin, this seemed like the simplest way to make my device waterproof. The containers are not completely transparent but they shouldn't make a significant impact on the light levels being recorded by the photo-resistor because they're also far from opaque. And these containers are sealable, waterproof and come in all shapes and sizes!</p>
<p>I took my elastic-band-wrapped &quot;stack&quot; of Arduino-plus-shield-plus-breadboard and connected it to the battery -</p>
<img alt="The Arduino 'stack' connected to a battery" src="/Content/Images/Posts/ArduinoStackWithBattery.jpg" class="NoBorder AlwaysFullWidth" title="The Arduino 'stack' connected to a battery" />
<p>.. and put in a plastic box. By turning the battery so that it was length-side-up, it was quite a snug fit and meant that the battery wouldn't slide around inside the box. There wasn't a lot of space for the stack to move around and so it seemed like quite a secure arrangement:</p>
<img alt="The Arduino 'stack' and battery in its waterproof container" src="/Content/Images/Posts/ArduinoInBox.jpg" class="NoBorder AlwaysFullWidth" title="The Arduino 'stack' and battery in its waterproof container" />
<h3 id="step-7-the-final-code"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-7-the-final-code">Step 7: The final code</a></h3>
<p>So far, each code sample has demonstrated <em>aspects</em> of what I want to do but now it's time to bring it all fully together.</p>
<p>In trying to write the following code, I was reminded how much I've taken for granted in C# (and other higher level languages) with their string handling! I tried a little C and C++ <em>maaaaany</em> years ago and so writing Arduino code was a bit of a throwback for me - at first, I was trying to make a char array for a filename and I set the length of the array to be the number of characters that were required for the filename.. silly me, I had forgotten that C strings need to be null-terminated and so you need an extra zero character at the end in order for things to work properly! Failing to do so would not result in a compile or run time error, it would just mean that the files weren't written properly. Oh, how I've been spoilt! But, on the other hand, it also feels kinda good being this close to the &quot;bare metal&quot; :)</p>
<p>The following sketch will record the light level about twice a minute to a file on the SD card where the filename is based upon the current date (as maintained by the RTC module and its CR1220 battery) -</p>
<pre><code>#include &lt;Wire.h&gt;
#include &lt;SdFat.h&gt;    // https://github.com/greiman/SdFat
#include &lt;RTClib.h&gt;   // https://github.com/adafruit/RTClib
#include &lt;LowPower.h&gt; // https://github.com/rocketscream/Low-Power

// chipSelect = 10 according to &quot;Item description&quot; section of
// https://www.play-zone.ch/de/dk-data-logging-shield-v1-0.html
#define SD_CHIP_SELECT 10

RTC_DS1307 rtc;

void setup() {
  // The clock won't work with this (thanks https://arduino.stackexchange.com/a/44305!)
  Wire.begin();

  bool rtcWasAlreadyConfigured;
  if (rtc.isrunning()) {
    rtcWasAlreadyConfigured = true;
  }
  else {
    rtc.adjust(DateTime(__DATE__, __TIME__));
    rtcWasAlreadyConfigured = false;
  }

  Serial.begin(9600);

  if (rtcWasAlreadyConfigured) {
    Serial.println(&quot;setup: RTC is already running&quot;);
  }
  else {
    Serial.println(&quot;setup: RTC was not running, so it was set to the time of compilation&quot;);
  }
}

void loop() {
  // Character arrays need to be long enough to store the number of &quot;real&quot; characters plus the
  // null terminator
  char filename[13]; // yyyyMMdd.txt = 12 chars + 1 null
  char timestamp[9]; // 00:00:00     =  8 chars + 1 null
  DateTime now = rtc.now();
  snprintf(filename, sizeof(filename), &quot;%04u%02u%02u.txt&quot;, now.year(), now.month(), now.day());
  snprintf(timestamp, sizeof(timestamp), &quot;%02u:%02u:%02u&quot;, now.hour(), now.minute(), now.second());

  int sensorValue = analogRead(0);

  Serial.print(filename);
  Serial.print(&quot; &quot;);
  Serial.print(timestamp);
  Serial.print(&quot; &quot;);
  Serial.println(sensorValue);

  SdFat sd;
  if (!sd.begin(SD_CHIP_SELECT, SPI_HALF_SPEED)) {
    Serial.println(&quot;ERROR: sd.begin() failed&quot;);
  }
  else {
    SdFile file;
    if (!file.open(filename, O_WRITE | O_APPEND | O_CREAT)) {
      Serial.println(&quot;ERROR: file.open() failed - unable to write&quot;);
    }
    else {
      file.print(timestamp);
      file.print(&quot; Sensor value: &quot;);
      file.println(sensorValue);
      file.close();
    }
  }

  Serial.flush(); // Ensure we finish sending serial messages before going to sleep

  // 4x 8s is close enough to a reading every 30s, which gives me plenty of data
  // - Using this instead of &quot;delay&quot; should mean that the battery will power the device for longer
  for (int i = 0; i &lt; 3; i++) {
    LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF);
  }
}
</code></pre>
<p>At the moment, I'm bringing the box inside each night and then disconnecting the battery, pulling out the card and looking at the values recorded in the file to see if it's clear when the sun was fully hitting the table that I had placed the box on.</p>
<p>I've only started doing this in the last couple of days and each day has been rather grey and so there haven't been any sunny periods so that I can confirm that the readings clearly distinguish between &quot;regular daylight&quot; and &quot;sun directly on the table&quot;. Once I get some sun again, I'll be able to get a better idea - and if I <em>can't</em> distinguish well enough then I'll adjust the pull-down resistor that splits the voltage with the LDR and keep experimenting!</p>
<p>When I'm happy with the configuration, <em>then</em> I'll start experimenting with leaving the box outside for longer to see how long this battery can last in conjunction with the &quot;LowPower.powerDown(..)&quot; calls. One obvious optimisation for my use case would be to continue keeping it in power-down mode between the hours of 10pm and 8am - partly because I know that it will definitely be dark after 10pm and partly because I am <em>not</em> a morning person and so would not want to be outside before 8am, even if it <em>was</em> streaming with light (which it wouldn't be due to when my yard actually gets direct sunlight).</p>
<p><strong>Gotcha Eight:</strong> The RTC has no awareness of daylight savings time and so I'll need to take this into account when the clocks change in the UK. I'll worry about this another day!</p>
<h3 id="step-8-draw-some-graphs-one-day"><a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#step-8-draw-some-graphs-one-day">Step 8: Draw some graphs (one day)</a></h3>
<p>As you can tell from the above, I'm still very much in the early phases of gathering data. But, at some point, I'm going to have to <em>use</em> this data to predict when the yard will get sun for future dates - once I've got a few months of data for different times of year, hopefully I'll be able to do so!</p>
<p>I foresee a little bit of data-reading and Excel-graph-drawing in my future! There's just something about seeing <a href="/when-a-disk-cache-performs-better-than-an-inmemory-cache-befriending-the-net-gc">results on a graph</a> that make everything feel so much more real. As much as I'd like to be able to stare at 1000s of numbers and read them like the Matrix, seeing trends and curves plotted out just feels so much more satisfying and definitive. Maybe there will be a follow-up post with the results, though I feel that they would be much more personal and less useful to the general populace than even <em>my</em> standard level of esoteric and niche blog posts! Maybe there are some graphs in my Twitter stream's future!</p>
<p>On the other hand.. if I learn any more power-saving techniques or have any follow-up information about how long these rechargeable torch-or-remote-control batteries last then maybe <em>that</em> will be grounds for a follow-up!</p>
<p>In the meantime, I hope you've enjoyed this little journey - and if you've tried to do anything similar with these cheap Deek Robot boards, then maybe the code samples here have been of use to you. I hope so! (Because, goodness knows, feeling like a beginner again and getting onto those new forums has been <em>quite</em> an experience!)</p>
<p class="PostTime">Posted at 21:34</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts-part-2">Automating &quot;suggested / related posts&quot; links for my blog posts - Part 2</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts">Automating &quot;suggested / related posts&quot; links for my blog posts</a></li><li><a href="/javascript-compression-putting-my-json-search-indexes-on-a-diet">JavaScript Compression (Putting my JSON Search Indexes on a diet)</a></li></ul></div>
            <p class="Comments">
                <a href="/monitoring-my-gardens-limited-sunlight-time-period-with-an-arduino-and-some-tupperware#disqus_thread" data-disqus-identifier="118">Comments</a>
            </p>
    </div>
    <div class="Content ArchiveByMonth">
        <p class="PostDate">7 August 2020</p><h2 id="how-are-barcodes-read-library-less-image-processing-in-c"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp">How are barcodes read?? (Library-less image processing in C#)</a></h2>
<p>I've been using MyFitnessPal and it has the facility to load nutrition information by scanning the barcode on the product. I can guess how the retrieval works once the barcode number is obtained (a big database somewhere) but it struck me that I had no idea how the reading of the barcode <em>itself</em> worked and.. well, I'm curious and enjoy the opportunity to learn something new to me by writing the code to do it. I do enjoy being able to look up (almost) anything on the internet to find out how it works!</p>
<p><em>(For anyone who wants to either play along but not copy-paste the code themselves or for anyone who wants to jump to the end result, I've put the code - along with the example image I've used in this post - up on a <a href="https://github.com/ProductiveRage/BarcodeReader">GitHub repo</a>)</em></p>
<h3 id="the-plan-of-attack"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#the-plan-of-attack">The plan of attack</a></h3>
<p>There are two steps required here:</p>
<ol>
<li>Read image and try to identify areas that look like barcodes</li>
<li>Try to extract numbers from the looks-like-a-barcode regions</li>
</ol>
<p>As with anything, these steps may be broken down into smaller tasks. The first step can be done like this:</p>
<ol>
<li>Barcodes are black and white regions that have content that has steep &quot;gradients&quot; in image intensity horizontally (where there is a change from a black bar to a white space) and little change in intensity vertically (as each bar is a vertical line), so first we greyscale the image and then generate horizontal and vertical intensity gradients values for each point in the image and combine the values by subtracting vertical gradient from horizontal gradient</li>
<li>These values are normalised so that they are all on the scale zero to one - this data could be portrayed as another greyscale image where the brightest parts are most likely to be within barcodes</li>
<li>These values are then &quot;spread out&quot; or &quot;blurred&quot; and then a threshold value is applied where every value about it is changed into a 1 and every value below it a 0</li>
<li>This &quot;mask&quot; (where every value is a 0 or 1) should have identified many of the pixels within the barcodes and we want to group these pixels into distinct objects</li>
<li>There is a chance, though, that there could be gaps between bars that mean that a single barcode is spread across multiple masked-out objects and we need to try to piece them back together into one area (since the bars are tall and narrow, this may be done by considering a square area over every object and then combining objects whose squared areas overlap into one)</li>
<li>This process will result in a list of areas that may be barcodes - any that are taller than they are wide are ignored (because barcode regions are always wider than they are tall)</li>
</ol>
<p>The second step can be broken down into:</p>
<ol>
<li>Take the maybe-barcode region of the image, greyscale it and then turn into a mask by setting any pixel with an intensity less than a particular threshold to zero and otherwise to one</li>
<li>Take a horizontal slice across the image region - all of the pixels on the first row of the image - and change the zero-or-one raw data into a list of line lengths where a new line starts at any transition from zero-to-one or one-to-zero (so &quot;01001000110&quot; becomes &quot;1,1,2,1,3,2,1&quot; because there is 1x zero and then 1x one and then 2x zero and then 1x one, etc..)</li>
<li>These line lengths should correspond to bar sizes (and space-between-bar sizes) if we've found a barcode - so run the values through the magic barcode bar-size-reading algorithm (see section 2.1 in <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2859730/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2859730/</a>) and if we get a number (and the checksum is correct) then we're done, hurrah!</li>
<li>If we couldn't get a number from this horizontal slice then move one pixel down and go back around</li>
<li>If it was not possible to extract a number from any of the slices through the image region then it's either not a barcode or it's somehow so distorted in the image that we can't read it</li>
</ol>
<p>This approach is fairly resilient to changes in lighting and orientation because the barcode regions are still likely to have the highest horizontal intensity gradient whether the image is dark or light (and even if <em>part</em> of the image is light and part of it is dark) and the barcode-reading algorithm works on ratios of bar/space-between-bar widths and these remain constant if the image is rotated.</p>
<p><em>(Some of the techniques are similar to things that I did in my <a href="/face-or-no-face-finding-faces-in-photos-using-c-sharp-and-accordnet">Face or no face (finding faces in photos using C# and Accord.NET)</a> and so I'll be using some of the same code shortly that I described then)</em></p>
<h3 id="identifying-maybe-barcode-images"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#identifying-maybe-barcode-images">Identifying maybe-barcode images</a></h3>
<p>Let's this image as an example to work with (peanut butter.. I <em>do</em> love peanut butter) -</p>
<img alt="Delicious peanut butter" src="/Content/Images/Posts/PeanutBarcode.jpg" class="NoBorder AlwaysFullWidth" title="Delicious peanut butter" />
<p>Before looking at any code, let's visualise the process.</p>
<p>We're going to consider horizontal and vertical gradient intensity maps - at every point in the image we either look to the pixels to the left and to the right (for the horizontal gradient) or we look at the pixels above and below (for the vertical gradient) and the larger the change, the brighter the pixel in the gradient intensity map</p>
<img alt="Horizontal gradient intensity" src="/Content/Images/Posts/PeanutBarcode-HorizontalAndVerticalGradients.jpg" class="NoBorder AlwaysFullWidth" title="Horizontal gradient intensity" />
<p>And when they're combined by subtracting the vertical gradient at each point from the horizontal gradient, it looks lke this:</p>
<img alt="Combined gradient intensity" src="/Content/Images/Posts/PeanutBarcode-CombinedGradients.jpg" class="NoBorder AlwaysFullWidth" title="Combined gradient intensity" />
<p>If this image is blurred then we get this:</p>
<img alt="Blurred combined gradient intensity" src="/Content/Images/Posts/PeanutBarcode-Blurred.jpg" class="NoBorder AlwaysFullWidth" title="Blurred combined gradient intensity" />
<p>.. and if we create a binary mask by saying &quot;normalise the intensity values so that their range goes from zero (for the darkest pixel) to one (for the brightest) and then set any pixels that are in the bottom third in terms of intensity to 0 and set the rest to 1&quot; then we get this:</p>
<img alt="Mask of possibly-part-of-a-barcode areas" src="/Content/Images/Posts/PeanutBarcode-Mask.jpg" class="NoBorder AlwaysFullWidth" title="Mask of possibly-part-of-a-barcode areas" />
<p>If each distinct area (where an &quot;area&quot; means &quot;a group of pixels that are connected&quot;) is identified and squares overlaid and centered around the areas then we see this:</p>
<img alt="Mask of possibly-part-of-a-barcode areas, extended into squared areas" src="/Content/Images/Posts/PeanutBarcode-MaskSquares.jpg" class="NoBorder AlwaysFullWidth" title="Mask of possibly-part-of-a-barcode areas, extended into squared areas" />
<p>.. and if the areas whose bounding squares overlap are combined and then cropped around the white pixels then we end up with this:</p>
<img alt="Combined possibly-a-barcode areas" src="/Content/Images/Posts/PeanutBarcode-MaskSquaresCombined.jpg" class="NoBorder AlwaysFullWidth" title="Combined possibly-a-barcode areas" />
<p>This has identified the area around the barcode and also two tiny other areas - when we come to trying to read barcode numbers out of these, the tiny regions will result in no value while the area around the genuine barcode content <em>should</em> result in a number successfully being read. But I'm getting ahead of myself.. let's look at the code required to perform the above transformations.</p>
<p>I'm going to start with a <strong>DataRectangle</strong> for performing transformations -</p>
<pre><code>public static class DataRectangle
{
    public static DataRectangle&lt;T&gt; For&lt;T&gt;(T[,] values) =&gt; new DataRectangle&lt;T&gt;(values);
}

public sealed class DataRectangle&lt;T&gt;
{
    private readonly T[,] _protectedValues;
    public DataRectangle(T[,] values) : this(values, isolationCopyMayBeBypassed: false) { }
    private DataRectangle(T[,] values, bool isolationCopyMayBeBypassed)
    {
        if ((values.GetLowerBound(0) != 0) || (values.GetLowerBound(1) != 0))
            throw new ArgumentException(&quot;Both dimensions must have lower bound zero&quot;);
        var arrayWidth = values.GetUpperBound(0) + 1;
        var arrayHeight = values.GetUpperBound(1) + 1;
        if ((arrayWidth == 0) || (arrayHeight == 0))
            throw new ArgumentException(&quot;zero element arrays are not supported&quot;);

        Width = arrayWidth;
        Height = arrayHeight;

        if (isolationCopyMayBeBypassed)
            _protectedValues = values;
        else
        {
            _protectedValues = new T[Width, Height];
            Array.Copy(values, _protectedValues, Width * Height);
        }
    }

    /// &lt;summary&gt;
    /// This will always be greater than zero
    /// &lt;/summary&gt;
    public int Width { get; }

    /// &lt;summary&gt;
    /// This will always be greater than zero
    /// &lt;/summary&gt;
    public int Height { get; }

    public T this[int x, int y]
    {
        get
        {
            if ((x &lt; 0) || (x &gt;= Width))
                throw new ArgumentOutOfRangeException(nameof(x));
            if ((y &lt; 0) || (y &gt;= Height))
                throw new ArgumentOutOfRangeException(nameof(y));
            return _protectedValues[x, y];
        }
    }

    public IEnumerable&lt;Tuple&lt;Point, T&gt;&gt; Enumerate(Func&lt;Point, T, bool&gt;? optionalFilter = null)
    {
        for (var x = 0; x &lt; Width; x++)
        {
            for (var y = 0; y &lt; Height; y++)
            {
                var value = _protectedValues[x, y];
                var point = new Point(x, y);
                if (optionalFilter?.Invoke(point, value) ?? true)
                    yield return Tuple.Create(point, value);
            }
        }
    }

    public DataRectangle&lt;TResult&gt; Transform&lt;TResult&gt;(Func&lt;T, TResult&gt; transformer)
    {
        return Transform((value, coordinates) =&gt; transformer(value));
    }

    public DataRectangle&lt;TResult&gt; Transform&lt;TResult&gt;(Func&lt;T, Point, TResult&gt; transformer)
    {
        var transformed = new TResult[Width, Height];
        for (var x = 0; x &lt; Width; x++)
        {
            for (var y = 0; y &lt; Height; y++)
                transformed[x, y] = transformer(_protectedValues[x, y], new Point(x, y));
        }
        return new DataRectangle&lt;TResult&gt;(transformed, isolationCopyMayBeBypassed: true);
    }
}
</code></pre>
<p>And then I'm going to add a way to load image data into this structure -</p>
<pre><code>public static class BitmapExtensions
{
    /// &lt;summary&gt;
    /// This will return values in the range 0-255 (inclusive)
    /// &lt;/summary&gt;
    // Based on http://stackoverflow.com/a/4748383/3813189
    public static DataRectangle&lt;double&gt; GetGreyscale(this Bitmap image)
    {
        var values = new double[image.Width, image.Height];
        var data = image.LockBits(
            new Rectangle(0, 0, image.Width, image.Height),
            ImageLockMode.ReadOnly,
            PixelFormat.Format24bppRgb
        );
        try
        {
            var pixelData = new Byte[data.Stride];
            for (var lineIndex = 0; lineIndex &lt; data.Height; lineIndex++)
            {
                Marshal.Copy(
                    source: data.Scan0 + (lineIndex * data.Stride),
                    destination: pixelData,
                    startIndex: 0,
                    length: data.Stride
                );
                for (var pixelOffset = 0; pixelOffset &lt; data.Width; pixelOffset++)
                {
                    // Note: PixelFormat.Format24bppRgb means the data is stored in memory as BGR
                    const int PixelWidth = 3;
                    var r = pixelData[pixelOffset * PixelWidth + 2];
                    var g = pixelData[pixelOffset * PixelWidth + 1];
                    var b = pixelData[pixelOffset * PixelWidth];
                    values[pixelOffset, lineIndex] = (0.2989 * r) + (0.5870 * g) + (0.1140 * b);
                }
            }
        }
        finally
        {
            image.UnlockBits(data);
        }
        return DataRectangle.For(values);
    }
}
</code></pre>
<p>With these classes, we can load an image and calculate the combined horizontal-gradient-minus-vertical-gradient value like this:</p>
<pre><code>private static IEnumerable&lt;Rectangle&gt; GetPossibleBarcodeAreasForBitmap(Bitmap image)
{
    var greyScaleImageData = image.GetGreyscale();
    var combinedGradients = greyScaleImageData.Transform((intensity, pos) =&gt;
    {
        // Consider gradients to be zero at the edges of the image because there aren't pixels
        // both left/right or above/below and so it's not possible to calculate a real value
        var horizontalChange = (pos.X == 0) || (pos.X == greyScaleImageData.Width - 1)
            ? 0
            : greyScaleImageData[pos.X + 1, pos.Y] - greyScaleImageData[pos.X - 1, pos.Y];
        var verticalChange = (pos.Y == 0) || (pos.Y == greyScaleImageData.Height - 1)
            ? 0
            : greyScaleImageData[pos.X, pos.Y + 1] - greyScaleImageData[pos.X, pos.Y - 1];
        return Math.Max(0, Math.Abs(horizontalChange) - Math.Abs(verticalChange));
    });

    // .. more will go here soon
}
</code></pre>
<p>Before jumping straight into the image analysis, though, it's worth resizing the source image if it's large. Since this stage of the processing is looking for areas that look approximately like barcodes, we don't require a lot of granularity - I'm envisaging (as with the MyFitnessPal use case) source images where the barcode takes up a significant space in the image and is roughly aligned with the view port* and so resizing the image such that the largest side is 300px should work well. If you wanted to scan an image where there were many barcodes to process (or even where there was only one but it was very small) then you might want to allow larger inputs than this - the more data that there is, though, the more work that must be done and the slower that the processing will be!</p>
<p>* <em>(The barcode has to be roughly aligned with the viewport because the approaching of looking for areas with large horizontal variance in intensity with minor vertical variance would not work - as we'll see later, though, there is considerable margin for error in this approach and perfect alignment is not required)</em></p>
<p>A naive approach to this would be force the image so that its largest side is 300px, regardless of what it was originally. However, this is unnecessary if the largest side is already less than 300px (scaling it up will actually give us more work to do) and if the largest side is not much more than 300px then it's probably not worth doing either - scaling it down may make any barcodes areas fuzzy and risk reducing the effectiveness of the processing while not actually reducing the required work. So I'm going to say that if the largest side of the image is 450px or larger than resize it so that its largest side is 300px and do nothing otherwise. To achieve that, we need a method like this:</p>
<pre><code>private static DataRectangle&lt;double&gt; GetGreyscaleData(
    Bitmap image,
    int resizeIfLargestSideGreaterThan,
    int resizeTo)
{
    var largestSide = Math.Max(image.Width, image.Height);
    if (largestSide &lt;= resizeIfLargestSideGreaterThan)
        return image.GetGreyscale();

    int width, height;
    if (image.Width &gt; image.Height)
    {
        width = resizeTo;
        height = (int)(((double)image.Height / image.Width) * width);
    }
    else
    {
        height = resizeTo;
        width = (int)(((double)image.Width / image.Height) * height);
    }
    using var resizedImage = new Bitmap(image, width, height);
    return resizedImage.GetGreyscale();
}
</code></pre>
<p>The next steps are to &quot;normalise&quot; the combined intensity variance values so that they fit the range zero-to-one, to &quot;blur&quot; this data and to then create a binary mask where the brighter pixels get set to one and the darker pixels get set to zero. In other words, to extend the code earlier (that calculated the intensity variance values) like this:</p>
<pre><code>private static IEnumerable&lt;Rectangle&gt; GetPossibleBarcodeAreasForBitmap(Bitmap image)
{
    var greyScaleImageData = GetGreyscaleData(
        image,
        resizeIfLargestSideGreaterThan: 450,
        resizeTo: 300
    );
    var combinedGradients = greyScaleImageData.Transform((intensity, pos) =&gt;
    {
        // Consider gradients to be zero at the edges of the image because there aren't pixels
        // both left/right or above/below and so it's not possible to calculate a real value
        var horizontalChange = (pos.X == 0) || (pos.X == greyScaleImageData.Width - 1)
            ? 0
            : greyScaleImageData[pos.X + 1, pos.Y] - greyScaleImageData[pos.X - 1, pos.Y];
        var verticalChange = (pos.Y == 0) || (pos.Y == greyScaleImageData.Height - 1)
            ? 0
            : greyScaleImageData[pos.X, pos.Y + 1] - greyScaleImageData[pos.X, pos.Y - 1];
        return Math.Max(0, Math.Abs(horizontalChange) - Math.Abs(verticalChange));
    });

    const int maxRadiusForGradientBlurring = 2;
    const double thresholdForMaskingGradients = 1d / 3;

    var mask = Blur(Normalise(combinedGradients), maxRadiusForGradientBlurring)
        .Transform(value =&gt; (value &gt;= thresholdForMaskingGradients));

    // .. more will go here soon
}
</code></pre>
<p>To do that we, need a &quot;Normalise&quot; method - which is simple:</p>
<pre><code>private static DataRectangle&lt;double&gt; Normalise(DataRectangle&lt;double&gt; values)
{
    var max = values.Enumerate().Max(pointAndValue =&gt; pointAndValue.Item2);
    return (max == 0)
        ? values
        : values.Transform(value =&gt; (value / max));
}
</code></pre>
<p>.. and a &quot;Blur&quot; method - which is a little less simple but hopefully still easy enough to follow <em>(for every point, look at the points around it and take an average of all of them; it just looks for a square area, which is fine for small &quot;maxRadius&quot; values but which might be better implemented as a circular area if large &quot;maxRadius&quot; values might be needed, which they aren't in this code):</em></p>
<pre><code>private static DataRectangle&lt;double&gt; Blur(DataRectangle&lt;double&gt; values, int maxRadius)
{
    return values.Transform((value, point) =&gt;
    {
        var valuesInArea = new List&lt;double&gt;();
        for (var x = -maxRadius; x &lt;= maxRadius; x++)
        {
            for (var y = -maxRadius; y &lt;= maxRadius; y++)
            {
                var newPoint = new Point(point.X + x, point.Y + y);
                if ((newPoint.X &lt; 0) || (newPoint.Y &lt; 0)
                || (newPoint.X &gt;= values.Width) || (newPoint.Y &gt;= values.Height))
                    continue;
                valuesInArea.Add(values[newPoint.X, newPoint.Y]);
            }
        }
        return valuesInArea.Average();
    });
}
</code></pre>
<p>This gets us to this point:</p>
<img alt="Mask of possibly-part-of-a-barcode areas" src="/Content/Images/Posts/PeanutBarcode-Mask.jpg" class="NoBorder AlwaysFullWidth" title="Mask of possibly-part-of-a-barcode areas" />
<p>.. which feels like good progress!</p>
<p>Now we need to try to identify distinct &quot;islands&quot; of pixels where each &quot;island&quot; or &quot;object&quot; is a set of points that are within a single connected area. A straightforward way to do that is to look at every point in the mask that is set to 1 and either:</p>
<ol>
<li>Perform a pixel-style &quot;flood fill&quot; starting at this point in order to find other points in an object</li>
<li>If this pixel has already been included in such a fill operation, do nothing (because it's already been accounted for)</li>
</ol>
<p>This was made easier for me by reading the article <a href="https://simpledevcode.wordpress.com/2015/12/29/flood-fill-algorithm-using-c-net/">Flood Fill algorithm (using C#.Net)</a>..</p>
<pre><code>private static IEnumerable&lt;IEnumerable&lt;Point&gt;&gt; GetDistinctObjects(DataRectangle&lt;bool&gt; mask)
{
    // Flood fill areas in the looks-like-bar-code mask to create distinct areas
    var allPoints = new HashSet&lt;Point&gt;(
        mask.Enumerate(optionalFilter: (point, isMasked) =&gt; isMasked).Select(point =&gt; point.Item1)
    );
    while (allPoints.Any())
    {
        var currentPoint = allPoints.First();
        var pointsInObject = GetPointsInObject(currentPoint).ToArray();
        foreach (var point in pointsInObject)
            allPoints.Remove(point);
        yield return pointsInObject;
    }

    // Inspired by code at
    // https://simpledevcode.wordpress.com/2015/12/29/flood-fill-algorithm-using-c-net/
    IEnumerable&lt;Point&gt; GetPointsInObject(Point startAt)
    {
        var pixels = new Stack&lt;Point&gt;();
        pixels.Push(startAt);

        var valueAtOriginPoint = mask[startAt.X, startAt.Y];
        var filledPixels = new HashSet&lt;Point&gt;();
        while (pixels.Count &gt; 0)
        {
            var currentPoint = pixels.Pop();
            if ((currentPoint.X &lt; 0) || (currentPoint.X &gt;= mask.Width)
            || (currentPoint.Y &lt; 0) || (currentPoint.Y &gt;= mask.Height))
                continue;

            if ((mask[currentPoint.X, currentPoint.Y] == valueAtOriginPoint)
            &amp;&amp; !filledPixels.Contains(currentPoint))
            {
                filledPixels.Add(new Point(currentPoint.X, currentPoint.Y));
                pixels.Push(new Point(currentPoint.X - 1, currentPoint.Y));
                pixels.Push(new Point(currentPoint.X + 1, currentPoint.Y));
                pixels.Push(new Point(currentPoint.X, currentPoint.Y - 1));
                pixels.Push(new Point(currentPoint.X, currentPoint.Y + 1));
            }
        }
        return filledPixels;
    }
}
</code></pre>
<p>The problem is that, even with the blurring we performed, there will likely be some groups of distinct objects that are actually part of a single barcode. These areas need to be joined together. It's quite possible for there to be relatively large gaps in the middle of barcodes (there is in the example that we've been looking at) and so we might not easily be able to just take the distinct objects that we've got and join together areas that seem &quot;close enough&quot;.</p>
<img alt="Areas that are possibly part of a barcode" src="/Content/Images/Posts/PeanutBarcode-MaskObjects.jpg" class="NoBorder AlwaysFullWidth" title="Areas that are possibly part of a barcode" />
<p>On the basis that individual bars in a barcode are tall compared to the largest possible width that any of them can be (which I'll go into more detail about later on), it seems like a reasonable idea to take any areas that are taller than they are wide and expand their width until they become square. That would give us this:</p>
<img alt="Mask of possibly-part-of-a-barcode areas, extended into squared areas" src="/Content/Images/Posts/PeanutBarcode-MaskSquares.jpg" class="NoBorder AlwaysFullWidth" title="Mask of possibly-part-of-a-barcode areas, extended into squared areas" />
<p>We'd then work out which of these &quot;squared off&quot; rectangles overlap (if any) and replace overlapping rectangles with rectangles that cover their combined areas, which would look like this:</p>
<img alt="Overlapping squared-off areas that have been combined" src="/Content/Images/Posts/PeanutBarcode-MaskSquaresCombinedPreTrimmed.jpg" class="NoBorder AlwaysFullWidth" title="Overlapping squared-off areas that have been combined" />
<p>The only problem with this is that the combined rectangles extend too far to the left and right of the areas, so we need to trim them down. The will be fairly straightforward because we have the information about what distinct objects there are and each object is just a list of points - so we work out which objects have points within each of the combined bounding areas and then we work out which out of all of the objects for each combined area has the smallest &quot;x&quot; value and smallest &quot;y&quot; value and which have the largest values. That way, we can change the combined bounding areas to only cover actual barcode pixels. Which would leave us with this:</p>
<img alt="Combined possibly-a-barcode areas" src="/Content/Images/Posts/PeanutBarcode-MaskSquaresCombined.jpg" class="NoBorder AlwaysFullWidth" title="Combined possibly-a-barcode areas" />
<p>That might sound like a lot of complicated work but if we take a bit of a brute force* approach to it then it can be expressed like this:</p>
<pre><code>private static IEnumerable&lt;Rectangle&gt; GetOverlappingObjectBounds(
    IEnumerable&lt;IEnumerable&lt;Point&gt;&gt; objects)
{
    // Translate each &quot;object&quot; (a list of connected points) into a bounding box (squared off if
    // it was taller than it was wide)
    var squaredOffBoundedObjects = new HashSet&lt;Rectangle&gt;(
        objects.Select((points, index) =&gt;
        {
            var bounds = Rectangle.FromLTRB(
                points.Min(p =&gt; p.X),
                points.Min(p =&gt; p.Y),
                points.Max(p =&gt; p.X) + 1,
                points.Max(p =&gt; p.Y) + 1
            );
            if (bounds.Height &gt; bounds.Width)
                bounds.Inflate((bounds.Height - bounds.Width) / 2, 0);
            return bounds;
        })
    );

    // Loop over the boundedObjects and reduce the collection by merging any two rectangles
    // that overlap and then starting again until there are no more bounds merges to perform
    while (true)
    {
        var combinedOverlappingAreas = false;
        foreach (var bounds in squaredOffBoundedObjects)
        {
            foreach (var otherBounds in squaredOffBoundedObjects)
            {
                if (otherBounds == bounds)
                    continue;

                if (bounds.IntersectsWith(otherBounds))
                {
                    squaredOffBoundedObjects.Remove(bounds);
                    squaredOffBoundedObjects.Remove(otherBounds);
                    squaredOffBoundedObjects.Add(Rectangle.FromLTRB(
                        Math.Min(bounds.Left, otherBounds.Left),
                        Math.Min(bounds.Top, otherBounds.Top),
                        Math.Max(bounds.Right, otherBounds.Right),
                        Math.Max(bounds.Bottom, otherBounds.Bottom)
                    ));
                    combinedOverlappingAreas = true;
                    break;
                }
            }
            if (combinedOverlappingAreas)
                break;
        }
        if (!combinedOverlappingAreas)
            break;
    }

    return squaredOffBoundedObjects.Select(bounds =&gt;
    {
        var allPointsWithinBounds = objects
            .Where(points =&gt; points.Any(point =&gt; bounds.Contains(point)))
            .SelectMany(points =&gt; points)
            .ToArray(); // Don't re-evaluate in the four accesses below
        return Rectangle.FromLTRB(
            left: allPointsWithinBounds.Min(p =&gt; p.X),
            right: allPointsWithinBounds.Max(p =&gt; p.X) + 1,
            top: allPointsWithinBounds.Min(p =&gt; p.Y),
            bottom: allPointsWithinBounds.Max(p =&gt; p.Y) + 1
        );
    });
}
</code></pre>
<p>* <em>(There are definitely more efficient ways that this could be done but since we're only looking at 300px images then we're not likely to end up with huge amounts of data to deal with)</em></p>
<p>To complete the process, we need to do three more things:</p>
<ol>
<li>Since barcodes are wider than they are tall, we can discard any regions that don't fit this shape (of which there are two in the example image)</li>
<li>The remaining regions are expanded a little across so that they more clearly surround the barcode region, rather than being butted right up to it (this will make the barcode reading process a little easier)</li>
<li>As the regions that have been identified may well be on a resized version of the source image, they may need to scaled up so that they correctly apply to the source</li>
</ol>
<p>To do that, we'll start from this code that we saw earlier:</p>
<pre><code>var mask = Blur(Normalise(combinedGradients), maxRadiusForGradientBlurring)
    .Transform(value =&gt; (value &gt;= thresholdForMaskingGradients));
</code></pre>
<p>.. and expand it like so (removing the &quot;// .. more will go here soon&quot; comment), using the methods above:</p>
<pre><code>// Determine how much the image was scaled down (if it had to be scaled down at all)
// by comparing the width of the potentially-scaled-down data to the source image
var reducedImageSideBy = (double)image.Width / greyScaleImageData.Width;

var mask = Blur(Normalise(combinedGradients), maxRadiusForGradientBlurring)
    .Transform(value =&gt; (value &gt;= thresholdForMaskingGradients));

return GetOverlappingObjectBounds(GetDistinctObjects(mask))
    .Where(boundedObject =&gt; boundedObject.Width &gt; boundedObject.Height)
    .Select(boundedObject =&gt;
    {
        var expandedBounds = boundedObject;
        expandedBounds.Inflate(width: expandedBounds.Width / 10, height: 0);
        expandedBounds.Intersect(
            Rectangle.FromLTRB(0, 0, greyScaleImageData.Width, greyScaleImageData.Height)
        );
        return new Rectangle(
            x: (int)(expandedBounds.X * reducedImageSideBy),
            y: (int)(expandedBounds.Y * reducedImageSideBy),
            width: (int)(expandedBounds.Width * reducedImageSideBy),
            height: (int)(expandedBounds.Height * reducedImageSideBy)
        );
    });
</code></pre>
<p>The final result is that the barcode has been successfully located on the image - hurrah!</p>
<img alt="Barcode located!" src="/Content/Images/Posts/PeanutBarcode-Identified.jpg" class="NoBorder AlwaysFullWidth" title="Barcode located!" />
<p>With this information, we should be able to extract regions or &quot;sub images&quot; from the source image and attempt to decipher the barcode value in it (presuming that there IS a bar code in it and we haven't got a false positive match).</p>
<p>As we'll see in a moment, the barcode doesn't have to be perfectly lined up - some rotation is acceptable (depending upon the image, up to around 20 or 30 degrees should be fine). The MyFitnessPal app has a couple of fallbacks that I've noticed, such as being able to read barcodes that are upside down or even back to front (which can happen if a barcode is scanned from the wrong side of a transparent wrapper). While I won't be writing code here for either of those approaches, I'm sure that you could envisage how it could be done - the source image data could be processed as described here and then, if no barcode is read, rotated 180 degrees and re-processed and reversed and re-processed, etc..</p>
<h3 id="how-to-read-a-bar-code"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#how-to-read-a-bar-code">How to read a bar code</a></h3>
<p>A barcode is comprised of both black and white bars - so it's not just the black parts that are significant, it is the spaces between them as well.</p>
<p>The format of a barcode is as follows:</p>
<ol>
<li>Three single-width bars (a black one, a white one and another black one) that are used to gauge what is considered to be a &quot;single width&quot;</li>
<li>Information for six numbers then appears, where each number is encoded by a sequence of four bars (white, black, white, black) - particular combinations of bar widths relate to particular digits (see below)</li>
<li>Another guard section appears with five single width bars (white, black, white, black, white)</li>
<li>Six more numbers appear (using the same bar-width-combinations encoding as before but the groups of four bars are now black, white, black, white)</li>
<li>A final guard section of three single width bards (black, white, black)</li>
</ol>
<p>The numbers are encoded using the following system:</p>
<pre><code> Digit      Bar widths

   0        3, 2, 1, 1
   1        2, 2, 2, 1
   2        2, 1, 2, 2
   3        1, 4, 1, 1
   4        1, 1, 3, 2
   5        1, 2, 3, 1
   6        1, 1, 1, 4
   7        1, 3, 1, 2
   8        1, 2, 1, 3
   9        3, 1, 1, 2
</code></pre>
<p><em>(Note that every combination of values totals 7 when they added up - this is very helpful later!)</em></p>
<p>To see what that looks like in the real world, here's a slice of that barcode from the jar of peanut butter with each section and each numberic value identified:</p>
<img alt="Barcode numbers interpreted" src="/Content/Images/Posts/PeanutBarcode-AnnotatedValues.png" class="NoBorder AlwaysFullWidth" title="Barcode numbers interpreted" />
<p><em>(I should point out that the article <a href="https://habr.com/en/post/439768/">How does a barcode work?</a> was extremely helpful in the research I did for this post and I'm very grateful to the author for having written it in such an approachable manner!)</em></p>
<p>Any combination of bar widths that is not found in the table is considered to be invalid. On the one hand, you might think that this a potential loss; the format could support more combinations of bar widths to encode more values and then more data could be packed into the same space. There is an advantage, however, to having relatively few valid combinations of bar widths - it makes easier to tell whether the information being read appears to be correct. If a combination is encountered that seems incorrect then the read attempt should be aborted and retried. The format has existed for decades and it would make sense, bearing that in mind, to prioritise making it easier for the hardware to read rather prioritising trying to cram as much data in there as possible. There is <em>also</em> a checksum included in the numerical data to try to catch any &quot;misreads&quot; but when working with low resolutions or hardware with little computing power, the easier that it is to bail out of a scan and to retry the better.</p>
<p>The way to tackle the reading is to:</p>
<ol>
<li>Convert the sub image to greyscale</li>
<li>Create a binary mask so that the darker pixels become 0 and the lighter ones become 1</li>
<li>Take a single line across the area</li>
<li>Change the individual 1s and 0s into lengths of continuous &quot;runs&quot; of values
<ul>
<li>eg. 0001100 would become 3, 2, 2 because there are three 0s then two 1s and then two 0s</li>
</ul>
</li>
<li>These runs of values will represent the different sized (black and white) bars that were encountered
<ul>
<li>For a larger image, each run length will be longer than for a small image but that won't matter because when we encounter runs of four bar length values that we think should be interpreted as a single digit, we'll do some dividing to try to guess the average size of a single width bar</li>
</ul>
</li>
<li>Take these runs of values, skip through the expected guard regions and try to interpret each set of four bars that is thought to represent a digit of the bar code as that digit</li>
<li>If successful then perform a checksum calculation on the output and return the value ass a success if it meets expectations</li>
<li>If the line couldn't be interpreted as a barcode or the checksum calculation fails then take the next line down and go back to step 4</li>
<li>If there are no more lines to attempt then a barcode could not be identified in the image</li>
</ol>
<p>This processing is fairly light computationally and so there is no need to resize the &quot;may be a barcode&quot; image region before attempting the work. In fact, it's benefical to <em>not</em> shrink it as shrinking it will likely make the barcode section fuzzier and that makes the above steps less likely to work - the ideal case for creating a binary mask is where there is no significant &quot;seepage&quot; of pixel intensity between the black bar areas and the white bar areas. That's not to say that the images have to be crystal clear or perfectly aligned with the camera because the redundancy built into the format works in our favour here - if one line across the image can't be read because it's fuzzy then there's a good chance that one of the other lines will be legible.</p>
<p>60 length values is the precise number that we expect to find - there is expected to be some blank space before the barcode starts (1) and then a guard section of three single-width lines that we use to gauge bar width (3) and then six numbers that are encoded in four bars each (6x4=24) and then a guard section of five single-width lines (5) and then six numbers (6x4=24) and then a final guard region of three single-width bars, giving 1+3+24+5+24+3=60.</p>
<p>There will likely be another section of blank content after the barcode that we ignore</p>
<p>If we don't want to validate the final guard region then we can work with a barcode image where some of the end of cut off, so long as the data for the 12 digits is there; in this case, 57 lengths if the minimum number that we can accept</p>
<h3 id="reading-the-numeric-value-with-code"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#reading-the-numeric-value-with-code">Reading the numeric value with code</a></h3>
<p>I'm going to try to present the code in approximately the same order as the steps presented above. So, firstly we need to convert the sub image to greyscale and create a binary mark from it. Then we'll go line by line down the image data and try to read a value. So we'll take this:</p>
<pre><code>public static string? TryToReadBarcodeValue(Bitmap subImage)
{
    const double threshold = 0.5;

     // Black lines are considered 1 and so we set to true if it's a dark pixel (and 0 if light)
    var mask = subImage.GetGreyscale().Transform(intensity =&gt; intensity &lt; (256 * threshold));
    for (var y = 0; y &lt; mask.Height; y++)
    {
        var value = TryToReadBarcodeValueFromSingleLine(mask, y);
        if (value is object)
            return value;
    }
    return null;
}
</code></pre>
<p>.. and the read-each-slice-of-the-image code looks like this:</p>
<pre><code>private static string? TryToReadBarcodeValueFromSingleLine(
    DataRectangle&lt;bool&gt; barcodeDetails,
    int sliceY)
{
    if ((sliceY &lt; 0) || (sliceY &gt;= barcodeDetails.Height))
        throw new ArgumentOutOfRangeException(nameof(sliceY));

    var lengths = GetBarLengthsFromBarcodeSlice(barcodeDetails, sliceY).ToArray();
    if (lengths.Length &lt; 57)
    {
        // As explained, we'd like 60 bars (which would include the final guard region) but we
        // can still make an attempt with 57 (but no fewer)
        // - There will often be another section of blank content after the barcode that we ignore
        // - If we don't want to validate the final guard region then we can work with a barcode
        //   image where some of the end is cut off, so long as the data for the 12 digits is
        //   there (this will be the case where there are only 57 lengths)
        return null;
    }

    var offset = 0;
    var extractedNumericValues = new List&lt;int&gt;();
    for (var i = 0; i &lt; 14; i++)
    {
        if (i == 0)
        {
            // This should be the first guard region and it should be a pattern of three single-
            // width bars
            offset += 3;
        }
        else if (i == 7)
        {
            // This should be the guard region in the middle of the barcode and it should be a
            // pattern of five single-width bars
            offset += 5;
        }
        else
        {
            var value = TryToGetValueForLengths(
                lengths[offset],
                lengths[offset + 1],
                lengths[offset + 2],
                lengths[offset + 3]
            );
            if (value is null)
                return null;
            extractedNumericValues.Add(value.Value);
            offset += 4;
        }
    }

    // Calculate what the checksum should be based upon the first 11 numbers and ensure that
    // the 12th matches it
    if (extractedNumericValues.Last() != CalculateChecksum(extractedNumericValues.Take(11)))
        return null;

    return string.Join(&quot;&quot;, extractedNumericValues);
}
</code></pre>
<p>With the code below, we find the runs of continous 0 or 1 lengths that will represent bars are return that list (again, for larger images each run will be longer and for smaller images each run will be shorter but this will be taken care of later) -</p>
<pre><code>private static IEnumerable&lt;int&gt; GetBarLengthsFromBarcodeSlice(
    DataRectangle&lt;bool&gt; barcodeDetails,
    int sliceY)
{
    if ((sliceY &lt; 0) || (sliceY &gt;= barcodeDetails.Height))
        throw new ArgumentOutOfRangeException(nameof(sliceY));

    // Take the horizontal slice of the data
    var values = new List&lt;bool&gt;();
    for (var x = 0; x &lt; barcodeDetails.Width; x++)
        values.Add(barcodeDetails[x, sliceY]);

    // Split the slice into bars - we only care about how long each segment is when they
    // alternate, not whether they're dark bars or light bars
    var segments = new List&lt;Tuple&lt;bool, int&gt;&gt;();
    foreach (var value in values)
    {
        if ((segments.Count == 0) || (segments[^1].Item1 != value))
            segments.Add(Tuple.Create(value, 1));
        else
            segments[^1] = Tuple.Create(value, segments[^1].Item2 + 1);
    }
    if ((segments.Count &gt; 0) &amp;&amp; !segments[0].Item1)
    {
        // Remove the white space before the first bar
        segments.RemoveAt(0);
    }
    return segments.Select(segment =&gt; segment.Item2);
}
</code></pre>
<p>Now we need to implement the &quot;TryToGetValueForLengths&quot; method that &quot;TryToReadBarcodeValueFromSingleLine&quot; calls. This takes four bar lengths that are thought to represent a single digit in the bar code value (they are not part of a guard region or anything like that). It take those four bar lengths and guesses how many pixels across a single bar would be - which is made my simpler by the fact that all of the possible combinations of bar lengths in the lookup chart that we saw earlier add up to 7.</p>
<p>There's a little flexibility introduced here to try to account for a low quality image or if the threshold was a bit strong in the creation of the binary mask; we'll take that calculated expected width of a single bar and tweak it up or down a little if apply that division to the bar lengths means that we made some of the bars too small that they disappeared or too large and it seemed like the total width would be more than seven single estimated-width bars. There's only a <em>little</em> flexibility here because if we fail then we can always try another line of the image! (Or maybe it will turn out that this sub image was a false positive match and there isn't a bar code in it at all).</p>
<pre><code>private static int? TryToGetValueForLengths(int l0, int l1, int l2, int l3)
{
    if (l0 &lt;= 0)
        throw new ArgumentOutOfRangeException(nameof(l0));
    if (l1 &lt;= 0)
        throw new ArgumentOutOfRangeException(nameof(l1));
    if (l2 &lt;= 0)
        throw new ArgumentOutOfRangeException(nameof(l2));
    if (l3 &lt;= 0)
        throw new ArgumentOutOfRangeException(nameof(l3));

    // Take a guess at what the width of a single bar is based upon these four values
    // (the four bars that encode a number should add up to a width of seven)
    var raw = new[] { l0, l1, l2, l3 };
    var singleWidth = raw.Sum() / 7d;
    var adjustment = singleWidth / 10;
    var attemptedSingleWidths = new HashSet&lt;double&gt;();
    while (true)
    {
        var normalised = raw.Select(x =&gt; Math.Max(1, (int)Math.Round(x / singleWidth))).ToArray();
        var sum = normalised.Sum();
        if (sum == 7)
            return TryToGetNumericValue(normalised[0], normalised[1], normalised[2], normalised[3]);

        attemptedSingleWidths.Add(singleWidth);
        if (sum &gt; 7)
            singleWidth += adjustment;
        else
            singleWidth -= adjustment;
        if (attemptedSingleWidths.Contains(singleWidth))
        {
            // If we've already tried this width-of-a-single-bar value then give up -
            // it doesn't seem like we can make the input values make sense
            return null;
        }
    }

    static int? TryToGetNumericValue(int i0, int i1, int i2, int i3)
    {
        var lookFor = string.Join(&quot;&quot;, new[] { i0, i1, i2, i3 });
        var lookup = new[]
        {
            // These values correspond to the lookup chart shown earlier
            &quot;3211&quot;, &quot;2221&quot;, &quot;2122&quot;, &quot;1411&quot;, &quot;1132&quot;, &quot;1231&quot;, &quot;1114&quot;, &quot;1312&quot;, &quot;1213&quot;, &quot;3112&quot;
        };
        for (var i = 0; i &lt; lookup.Length; i++)
        {
            if (lookFor == lookup[i])
                return i;
        }
        return null;
    }
}
</code></pre>
<p>Finally we need the CalculateChecksum method (as noted in the code, there's a great explanation of how to do this in <a href="https://en.wikipedia.org/wiki/Check_digit#UPC">wikipedia</a>) -</p>
<pre><code>private static int CalculateChecksum(IEnumerable&lt;int&gt; values)
{
    if (values == null)
        throw new ArgumentNullException(nameof(values));
    if (values.Count() != 11)
        throw new ArgumentException(&quot;Should be provided with precisely 11 values&quot;);

    // See https://en.wikipedia.org/wiki/Check_digit#UPC
    var checksumTotal = values
        .Select((value, index) =&gt; (index % 2 == 0) ? (value * 3) : value)
        .Sum();
    var checksumModulo = checksumTotal % 10;
    if (checksumModulo != 0)
        checksumModulo = 10 - checksumModulo;
    return checksumModulo;
}
</code></pre>
<p>With this code, we have executed all of the planned steps outlined before.</p>
<p>It should be noted that, even with the small amount of flexibility in the &quot;TryToGetValueForLengths&quot; method, in the peanut butter bar code example it requires 15 calls to &quot;GetBarLengthsFromBarcodeSlice&quot; until a bar code is successfully matched! Presumably, this is because there is a little more distortion further up the bar code due to the curve of the jar.</p>
<p>That's not to say, however, that this approach to bar reading is particularly fussy. The redundancy and simplicity, not to mention the <em>size</em> of the average bar code, means that there is plenty of opportunity to try reading a sub image in multiple slices until one of them does match. In fact, I mentioned earlier that the barcode doesn't have to be perfectly at 90 degrees in order to be interpretable and that some rotation is acceptable. This hopefully makes some intuitive sense based upon the logic above and how it doesn't matter how long each individual bar code line is because they are averaged out - if a bar code was rotated a little and then a read was attempted of it line by line then the ratios between each line should remain consistent and the same data should be readable.</p>
<p>To illustrate, here's a zoomed-in section of the middle of the peanut butter bar code in the orientation shown so far:</p>
<img alt="A strip of the peanut butter jar's bar code" src="/Content/Images/Posts/PeanutBarcode-SingleStrip.jpg" class="NoBorder AlwaysFullWidth" title="A strip of the peanut butter jar's bar code" />
<p>If we then rotate it like this:</p>
<img alt="The peanut butter jar rotated slightly" src="/Content/Images/Posts/PeanutBarcode-Rotated.png" class="NoBorder AlwaysFullWidth" title="The peanut butter jar rotated slightly" />
<p>.. then the code above will still read the value correctly because a strip across the rotated bar code looks like this:</p>
<img alt="A strip of the peanut butter jar's bar code from the rotated image" src="/Content/Images/Posts/PeanutBarcode-SingleStripFromRotated.png" class="NoBorder AlwaysFullWidth" title="A strip of the peanut butter jar's bar code from the rotated image" />
<p>Hopefully it's clear enough that, for each given line, the ratios are essentially the same as for the non-rotated strip:</p>
<img alt="A strip of the peanut butter jar's bar code" src="/Content/Images/Posts/PeanutBarcode-SingleStrip.jpg" class="NoBorder AlwaysFullWidth" title="A strip of the peanut butter jar's bar code" />
<p>To get a reading from an image that is rotated more than this requires a very clear source image and will still be limited by the first stage of processing - that tried to find sections where the horizontal image intensity changed with steep gradients but the vertical intensity did not. If the image is rotated too much then there will be more vertical image intensity differences encountered and it is less likely to identify it as a &quot;maybe a bar code&quot; region.</p>
<p><em>(Note: I experimented with rotated images that were produced by an online barcode generator and had more success - meaning that I could rotate them more than I could with real photographs - but that's because those images are generated with stark black and white and the horizontal / vertical intensity gradients are maintained for longer when the image is rotated if they start with such a high level of clarity.. I'm more interested in reading values from real photographs and so I would suggest that only fairly moderate rotation will work - though it would still be plenty for an MyFitnessPal-type app that expects the User to hold the bar code in roughly the right orientation!)</em></p>
<h3 id="tying-it-all-together"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#tying-it-all-together">Tying it all together</a></h3>
<p>We've looked at the separate steps involved in the whole reading process, all that is left is to combine them. The &quot;GetPossibleBarcodeAreasForBitmap&quot; and &quot;TryToReadBarcodeValue&quot; methods can be put together into a fully functioning program like this:</p>
<pre><code>static void Main()
{
    using var image = new Bitmap(&quot;Source.jpg&quot;);

    var barcodeValues = new List&lt;string&gt;();
    foreach (var area in GetPossibleBarcodeAreasForBitmap(image))
    {
        using var areaBitmap = new Bitmap(area.Width, area.Height);
        using (var g = Graphics.FromImage(areaBitmap))
        {
            g.DrawImage(
                image,
                destRect: new Rectangle(0, 0, areaBitmap.Width, areaBitmap.Height),
                srcRect: area,
                srcUnit: GraphicsUnit.Pixel
            );
        }
        var valueFromBarcode = TryToReadBarcodeValue(areaBitmap);
        if (valueFromBarcode is object)
            barcodeValues.Add(valueFromBarcode);
    }

    if (!barcodeValues.Any())
        Console.WriteLine(&quot;Couldn't read any bar codes from the source image :(&quot;);
    else
    {
        Console.WriteLine(&quot;Read the following bar code(s) from the image:&quot;);
        foreach (var barcodeValue in barcodeValues)
            Console.WriteLine(&quot;- &quot; + barcodeValue);
    }

    Console.WriteLine();
    Console.WriteLine(&quot;Press [Enter] to terminate..&quot;);
    Console.ReadLine();
}
</code></pre>
<h3 id="finito"><a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#finito">Finito!</a></h3>
<p>And with that, we're finally done! I must admit that I started writing this post about three years ago and it's been in my TODO list for a loooooong time now. But I've taken a week off work and been able to catch up with a few things and have finally been able to cross it off the list. And I'm quite relieved that I didn't give up on it entirely because it was a fun little project and coming back to it now allowed me to tidy it up a bit with the newer C# 8 syntax and even enable the nullable reference types option on the project (I sure do hate unintentional nulls being allowed to sneak in!)</p>
<p>A quick reminder if you want to see it in action or play about it yourself, the <a href="https://github.com/ProductiveRage/BarcodeReader">GitHub repo is here</a>.</p>
<p>Thanks to anyone that read this far!</p>
<p class="PostTime">Posted at 23:24</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/face-or-no-face-finding-faces-in-photos-using-c-sharp-and-accordnet">Face or no face (finding faces in photos using C# and Accord.NET)</a></li><li><a href="/a-followup-to-implementing-f-sharp-inspired-with-updates-in-c-sharp">A follow-up to &quot;Implementing F#-inspired &#x27;with&#x27; updates in C#&quot;</a></li><li><a href="/implementing-f-sharp-inspired-with-updates-for-immutable-classes-in-c-sharp">Implementing F#-inspired &quot;with&quot; updates for immutable classes in C#</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/Image%20Processing" title="2 Posts">Image Processing</a></li></ul></div>
            <p class="Comments">
                <a href="/how-are-barcodes-read-libraryless-image-processing-in-c-sharp#disqus_thread" data-disqus-identifier="117">Comments</a>
            </p>
    </div>
    <div class="Content ArchiveByMonth">
        <p class="PostDate">4 August 2020</p><h2 id="removing-all-assembly-names-in-json.net-typenamehandling-output"><a href="/removing-all-assembly-names-in-jsonnet-typenamehandling-output">Removing ALL assembly names in Json.NET TypeNameHandling output</a></h2>
<p>In some cases, it may be desirable to include type name information in <a href="https://www.newtonsoft.com/json">Json.NET</a> output but for those type names to not include assembly names.</p>
<p>In my case it's because I have a <a href="https://dev.to/rionmonster/sharing-is-caring-using-shared-projects-in-aspnet-e17">Shared Project</a> that contains classes that I want to appear in my .NET Core C# server code and in my <a href="https://bridge.net/">Bridge.NET</a> client code and this results in the class names existing in assemblies with different names (but there are also other people with their own cases, such as <a href="https://stackoverflow.com/questions/8039910/how-do-i-omit-the-assembly-name-from-the-type-name-while-serializing-and-deseria">How do I omit the assembly name from the type name while serializing and deserializing in JSON.Net?</a>.</p>
<p>Json.NET has support for customising how the type names are emitted and there is an answer in the Stack Overflow question that I linked just above that points to an <a href="http://james.newtonking.com/archive/2011/11/19/json-net-4-0-release-4-bug-fixes">article</a> written by the Json.NET author illustrating how to do it. Essentially, you create a custom serialization binder that looks a bit like this:</p>
<pre><code>public sealed class TypeNameAssemblyExcludingSerializationBinder : ISerializationBinder
{
    public static TypeNameAssemblyExcludingSerializationBinder Instance { get; }
        = new TypeNameAssemblyExcludingSerializationBinder();

    private TypeNameAssemblyExcludingSerializationBinder() { }

    public void BindToName(Type serializedType, out string assemblyName, out string typeName)
    {
        assemblyName = null;
        typeName = serializedType.FullName;
    }

    public Type BindToType(string assemblyName, string typeName)
    {
        // Note: Some additional work may be required here if the assembly name has been removed
        // and you are not loading a type from the current assembly or one of the core libraries
        return Type.GetType(typeName);
    }
}
</code></pre>
<p>Then you serialise your content something like this:</p>
<pre><code>var json = JsonConvert.SerializeObject(
    new ExampleClass(123, &quot;Test&quot;),
    new JsonSerializerSettings
    {
        Formatting = Formatting.Indented,
        TypeNameHandling = TypeNameHandling.All,
        SerializationBinder = TypeNameAssemblyExcludingSerializationBinder.Instance
    }
);
</code></pre>
<p>If the <strong>ExampleClass</strong> looked like this:</p>
<pre><code>public sealed class ExampleClass
{
    public ExampleClass(int key, string name)
    {
        Key = key;
        Name = name;
    }
    public int Key { get; }
    public string Name { get; }
}
</code></pre>
<p>.. and was in a namespace called &quot;Tester&quot; then the resulting JSON would look like this:</p>
<pre><code>{
  &quot;$type&quot;: &quot;Tester.ExampleClass&quot;,
  &quot;Key&quot;: 123,
  &quot;Name&quot;: &quot;Test&quot;
}
</code></pre>
<p>To make the difference clear, if the custom serialisation binder had not been used (and if the containing assembly was also called &quot;Tester&quot;) then the JSON would have looked like this:</p>
<pre><code>{
  &quot;$type&quot;: &quot;Tester.ExampleClass, Tester&quot;,
  &quot;Key&quot;: 123,
  &quot;Name&quot;: &quot;Test&quot;
}
</code></pre>
<p>So.. problem solved!</p>
<p>Yes?</p>
<p>No.</p>
<h3 id="iserializationbinder-is-not-applied-to-generic-type-parameters"><a href="/removing-all-assembly-names-in-jsonnet-typenamehandling-output#iserializationbinder-is-not-applied-to-generic-type-parameters">ISerializationBinder is not applied to generic type parameters</a></h3>
<p>While everything was hunkydory in the example above, there are cases where it isn't. For example, if we wanted to serialise a <em>list</em> of <strong>ExampleClass</strong> instances then we'd have code like this:</p>
<pre><code>var json = JsonConvert.SerializeObject(
    new List&lt;ExampleClass&gt; { new ExampleClass(123, &quot;Test&quot;) },
    new JsonSerializerSettings
    {
        Formatting = Formatting.Indented,
        TypeNameHandling = TypeNameHandling.All,
        SerializationBinder = TypeNameAssemblyExcludingSerializationBinder.Instance
    }
);
</code></pre>
<p>.. and the resulting JSON would look like this:</p>
<pre><code>{
  &quot;$type&quot;: &quot;System.Collections.Generic.List`1[[Tester.ExampleClass, Tester]]&quot;,
  &quot;$values&quot;: [
    {
      &quot;$type&quot;: &quot;Tester.ExampleClass&quot;,
      &quot;Key&quot;: 123,
      &quot;Name&quot;: &quot;Test&quot;
    }
  ]
}
</code></pre>
<p>Without the custom serialisation binder, it would have looked like this:</p>
<pre><code>{
  &quot;$type&quot;: &quot;System.Collections.Generic.List`1[[Tester.ExampleClass, Tester]], System.Private.CoreLib&quot;,
  &quot;$values&quot;: [
    {
      &quot;$type&quot;: &quot;Tester.ExampleClass, Tester&quot;,
      &quot;Key&quot;: 123,
      &quot;Name&quot;: &quot;Test&quot;
    }
  ]
}
</code></pre>
<p>.. and so we've successfully removed <em>some</em> of the assembly names as there is no mention of &quot;System.Private.CoreLib&quot; in the List's type and the $type string for the <strong>ExampleClass</strong> instance no longer mentions the &quot;Tester&quot; assembly name but the generic type of the List <em>does</em> mention the &quot;Tester&quot; assembly name and we were trying to prevent assembly names from appearing in the type data!</p>
<p>I've had a good Google around this and there doesn't seem to be a definitive answer anywhere and I had a need for one, so I've put together a solution that does what I need. There is an answer to a similar(ish) stack overflow question <a href="https://stackoverflow.com/a/19927484/3813189">here</a> but it ends with a disclaimer that the regex provided would need tweaking to support nested types and <strong>a)</strong> I definitely wanted to support nested generic type parameters (eg. a Dictionary that maps string keys to List-of-int values) and <strong>b)</strong> regexes and me are not the best of friends - hence my going about it my own way!</p>
<pre><code>public sealed class TypeNameAssemblyExcludingSerializationBinder : ISerializationBinder
{
    public static TypeNameAssemblyExcludingSerializationBinder Instance { get; }
        = new TypeNameAssemblyExcludingSerializationBinder();
    private TypeNameAssemblyExcludingSerializationBinder() { }

    public void BindToName(Type serializedType, out string assemblyName, out string typeName)
    {
        // Note: Setting the assemblyName to null here will only remove it from the main type itself -
        // it won't remove it from any types specified as generic type parameters (that's what the
        // RemoveAssemblyNames method is needed for)
        assemblyName = null;
        typeName = RemoveAssemblyNames(serializedType.FullName);
    }

    public Type BindToType(string assemblyName, string typeName)
    {
        // Note: Some additional work may be required here if the assembly name has been removed
        // and you are not loading a type from the current assembly or one of the core libraries
        return Type.GetType(typeName);
    }

    private static string RemoveAssemblyNames(string typeName)
    {
        var index = 0;
        var content = new StringBuilder();
        RecusivelyRemoveAssemblyNames();
        return content.ToString();

        void RecusivelyRemoveAssemblyNames()
        {
            // If we started inside a type name - eg.
            //
            //   &quot;System.Int32, System.Private.CoreLib&quot;
            //
            // .. then we want to look for the comma that separates the type name from the assembly
            // information and ignore that content. If we started inside nested generic type content
            // - eg.
            //
            //  &quot;[System.Int32, System.Private.CoreLib], [System.String, System.Private.CoreLib]&quot;
            //
            // .. then we do NOT want to start ignoring content after any commas encountered. So
            // it's important to know here which case we're in.
            var insideTypeName = typeName[index] != '[';

            var ignoreContent = false;
            while (index &lt; typeName.Length)
            {
                var c = typeName[index];
                index++;

                if (insideTypeName &amp;&amp; (c == ','))
                {
                    ignoreContent = true;
                    continue;
                }

                if (!ignoreContent)
                    content.Append(c);

                if (c == '[')
                    RecusivelyRemoveAssemblyNames();
                else if (c == ']')
                {
                    if (ignoreContent)
                    {
                        // If we encountered a comma that indicated that we were about to start
                        // an assembly name then we'll have stopped adding content to the string
                        // builder but we don't want to lose this closing brace, so explicitly
                        // add it in if that's the case
                        content.Append(c);
                    }
                    break;
                }
            }
        }
    }
}
</code></pre>
<h3 id="a-note-about-resolving-types-from-type-names-without-assemblies"><a href="/removing-all-assembly-names-in-jsonnet-typenamehandling-output#a-note-about-resolving-types-from-type-names-without-assemblies">A note about resolving types from type names (without assemblies)</a></h3>
<p>In .NET, the &quot;Type.GetType&quot; method will return null if it is given a type name that does not correspond to a type that exists in either the current assembly or in one of the core .NET libraries. In Bridge.NET, it doesn't appear that they maintained that requirement and I believe that all types are available, even if an assembly name is not specified - but whether it is or isn't, a similar approach could be used in both cases where you use reflection to look at all loaded assemblies and all of their available types and try to map assembly-name-less type names onto one of those. Getting into this would be completely out of the scope of this post and I'm hoping that you already have an idea in mind if you had got to the point where you wanted to remove all assembly names from your type metadata!</p>
<p class="PostTime">Posted at 17:25</p><div class="Related"><h3>You may also be interested in (see <a href="/automating-suggested-related-posts-links-for-my-blog-posts">here</a> for information about how these are generated):</h3><ul><li><a href="/using-roslyn-code-fixes-to-make-the-frictionless-immutable-objects-in-bridge-even-easier">Using Roslyn code fixes to make the &quot;Friction-less immutable objects in Bridge&quot; even easier</a></li><li><a href="/writing-a-brackets-extension-in-typescript-in-brackets">Writing a Brackets extension in TypeScript, in Brackets</a></li><li><a href="/if-you-can-keep-your-head-when-all-about-you-are-losing-theirs-and-blaming-it-on-vbscript">If you can keep your head when all about you are losing theirs and blaming it on VBScript</a></li></ul></div><div class="Tags"><label>Tags:</label><ul><li><a href="/Archive/Tag/Bridge" title="12 Posts">Bridge</a></li></ul></div>
            <p class="Comments">
                <a href="/removing-all-assembly-names-in-jsonnet-typenamehandling-output#disqus_thread" data-disqus-identifier="116">Comments</a>
            </p>
    </div>

        <script type="text/javascript">
            (function () {
                var s = document.createElement("script");
                s.type = "text/javascript";
                s.async = true;
                s.src = "https://" + disqus_shortname + ".disqus.com/count.js";
                (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
            }());
        </script>

				<div class="Footer">
					© Productive Rage 2011 - 2022
				</div>
			</div>

			<div class="SideBar">
				<div class="About">
					<h2>About</h2>
					<p>Dan is a big geek who likes making stuff with computers! He can be quite outspoken so clearly needs a blog :)</p>
					<p>In the last few minutes he seems to have taken to referring to himself in the third person. He's quite enjoying it.</p>
					<p><a href="mailto:dangger36@gmail.com" class="Email">dangger36@gmail.com</a></p>
				</div>
				<div class="Search">
<form action="/Search" autocomplete="off" class="Search" method="get">						<div>
							<label class="SearchField">
								<span class="text">Site Search</span>
								<input type="text" class="SiteSearch" name="term" value="" />
							</label>
							<input type="submit" class="SiteSearchSubmit" value="Search" />
						</div>
</form>				</div>
				<div class="Recent"><h2>Recent Posts</h2><ul><li><a href="/so-what-is-machine-learning-nocodeintro">So.. what is machine learning? (#NoCodeIntro)</a></li><li><a href="/parallelising-linq-work-in-c-sharp">Parallelising (LINQ) work in C#</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts-part-2">Automating &quot;suggested / related posts&quot; links for my blog posts - Part 2</a></li><li><a href="/automating-suggested-related-posts-links-for-my-blog-posts">Automating &quot;suggested / related posts&quot; links for my blog posts</a></li><li><a href="/language-detection-and-wordsinsentence-classification-in-c-sharp">Language detection and words-in-sentence classification in C#</a></li></ul><div class="RSSFeedLink"><a href="https://www.productiverage.com/feed">RSS Feed</a></div></div>
				<div class="Featured"><h2>Highlights</h2><ul><li><a href="/face-or-no-face-finding-faces-in-photos-using-c-sharp-and-accordnet">Face or no face (finding faces in photos using C# and Accord.NET)</a></li><li><a href="/when-a-disk-cache-performs-better-than-an-inmemory-cache-befriending-the-net-gc">When a disk cache performs better than an in-memory cache (befriending the .NET GC)</a></li><li><a href="/performance-tuning-a-bridgenet-react-app">Performance tuning a Bridge.NET / React app</a></li><li><a href="/creating-a-c-sharp-roslyn-analyser-for-beginners-by-a-beginner">Creating a C# (&quot;Roslyn&quot;) Analyser - For beginners by a beginner</a></li><li><a href="/translating-vbscript-into-c-sharp">Translating VBScript into C#</a></li><li><a href="/entity-framework-projections-to-immutable-types-ienumerable-vs-iqueryable">Entity Framework projections to Immutable Types (IEnumerable vs IQueryable)</a></li></ul></div>
				<div class="History"><h2>Archives</h2><ul><li><a href="/Archive/2/2022">February 2022 (1)</a></li><li><a href="/Archive/8/2021">August 2021 (1)</a></li><li><a href="/Archive/4/2021">April 2021 (2)</a></li><li><a href="/Archive/3/2021">March 2021 (1)</a></li><li><a href="/Archive/8/2020">August 2020 (3)</a></li><li><a href="/Archive/7/2019">July 2019 (2)</a></li><li><a href="/Archive/9/2018">September 2018 (1)</a></li><li><a href="/Archive/4/2018">April 2018 (1)</a></li><li><a href="/Archive/3/2018">March 2018 (1)</a></li><li><a href="/Archive/7/2017">July 2017 (1)</a></li><li><a href="/Archive/6/2017">June 2017 (1)</a></li><li><a href="/Archive/2/2017">February 2017 (1)</a></li><li><a href="/Archive/11/2016">November 2016 (1)</a></li><li><a href="/Archive/9/2016">September 2016 (2)</a></li><li><a href="/Archive/8/2016">August 2016 (1)</a></li><li><a href="/Archive/7/2016">July 2016 (1)</a></li><li><a href="/Archive/6/2016">June 2016 (1)</a></li><li><a href="/Archive/5/2016">May 2016 (3)</a></li><li><a href="/Archive/3/2016">March 2016 (3)</a></li><li><a href="/Archive/2/2016">February 2016 (2)</a></li><li><a href="/Archive/12/2015">December 2015 (1)</a></li><li><a href="/Archive/11/2015">November 2015 (2)</a></li><li><a href="/Archive/8/2015">August 2015 (3)</a></li><li><a href="/Archive/7/2015">July 2015 (1)</a></li><li><a href="/Archive/6/2015">June 2015 (1)</a></li><li><a href="/Archive/5/2015">May 2015 (2)</a></li><li><a href="/Archive/4/2015">April 2015 (1)</a></li><li><a href="/Archive/3/2015">March 2015 (1)</a></li><li><a href="/Archive/1/2015">January 2015 (2)</a></li><li><a href="/Archive/12/2014">December 2014 (1)</a></li><li><a href="/Archive/11/2014">November 2014 (1)</a></li><li><a href="/Archive/10/2014">October 2014 (2)</a></li><li><a href="/Archive/9/2014">September 2014 (2)</a></li><li><a href="/Archive/8/2014">August 2014 (1)</a></li><li><a href="/Archive/7/2014">July 2014 (1)</a></li><li><a href="/Archive/6/2014">June 2014 (1)</a></li><li><a href="/Archive/5/2014">May 2014 (2)</a></li><li><a href="/Archive/2/2014">February 2014 (1)</a></li><li><a href="/Archive/1/2014">January 2014 (1)</a></li><li><a href="/Archive/12/2013">December 2013 (1)</a></li><li><a href="/Archive/11/2013">November 2013 (1)</a></li><li><a href="/Archive/10/2013">October 2013 (1)</a></li><li><a href="/Archive/8/2013">August 2013 (3)</a></li><li><a href="/Archive/7/2013">July 2013 (3)</a></li><li><a href="/Archive/6/2013">June 2013 (1)</a></li><li><a href="/Archive/5/2013">May 2013 (2)</a></li><li><a href="/Archive/4/2013">April 2013 (1)</a></li><li><a href="/Archive/3/2013">March 2013 (8)</a></li><li><a href="/Archive/2/2013">February 2013 (2)</a></li><li><a href="/Archive/1/2013">January 2013 (2)</a></li><li><a href="/Archive/12/2012">December 2012 (3)</a></li><li><a href="/Archive/11/2012">November 2012 (4)</a></li><li><a href="/Archive/9/2012">September 2012 (1)</a></li><li><a href="/Archive/8/2012">August 2012 (1)</a></li><li><a href="/Archive/7/2012">July 2012 (3)</a></li><li><a href="/Archive/6/2012">June 2012 (3)</a></li><li><a href="/Archive/5/2012">May 2012 (2)</a></li><li><a href="/Archive/2/2012">February 2012 (3)</a></li><li><a href="/Archive/1/2012">January 2012 (4)</a></li><li><a href="/Archive/12/2011">December 2011 (7)</a></li><li><a href="/Archive/8/2011">August 2011 (2)</a></li><li><a href="/Archive/7/2011">July 2011 (1)</a></li><li><a href="/Archive/5/2011">May 2011 (1)</a></li><li><a href="/Archive/4/2011">April 2011 (2)</a></li><li><a href="/Archive/3/2011">March 2011 (3)</a></li></ul><div class="EveryTitle"><a href="/Archive/All">Every Post Title</a></div></div>
			</div>

		</div>
	</div>

	<script type="text/javascript" src="/Scripts/autocomplete.js"></script>
	<script type="text/javascript" src="/Scripts/prettify.js"></script>
	<script type="text/javascript" src="/Scripts/Site.js"></script>
	<script type="text/javascript" src="/Scripts/IndexSearchGenerator.js"></script>
	<script type="text/javascript" src="/Scripts/SearchTermHighlighter.js"></script>
	<script type="text/javascript" src="/Scripts/SearchPage.js"></script>
	<script type="text/javascript" src="/Scripts/LZString.js"></script>

</body>
</html>
